(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3970],{8079:function(e,t,i){Promise.resolve().then(i.bind(i,1974))},1974:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return f}});var r=i(7437),s=i(2265),n=i(4033),a=i(1827),o=i(2176),l=i(2741),d=i(8339),c=i(290),u=i(6020),m=i(8228),h=i(5022);function f(){let e=(0,n.useRouter)(),{user:t,isAuthenticated:i}=(0,m.a)(),[f,g]=(0,s.useState)([]),[p,x]=(0,s.useState)(null),[y,b]=(0,s.useState)([]),[v,j]=(0,s.useState)(""),[w,k]=(0,s.useState)(""),[C,T]=(0,s.useState)(!0),S=[{id:"conv-1",userId:"user-1",userName:"張小明",userAvatar:"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face",lastMessage:"請問明天的行程可以調整嗎？",lastMessageTime:"10:30",unreadCount:2,isOnline:!0,serviceTitle:"台北101 & 信義區深度導覽",bookingId:"booking-1"},{id:"conv-2",userId:"user-2",userName:"李小華",userAvatar:"https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face",lastMessage:"謝謝您的詳細介紹！",lastMessageTime:"昨天",unreadCount:0,isOnline:!1,serviceTitle:"九份老街 & 金瓜石礦業遺址",bookingId:"booking-2"},{id:"conv-3",userId:"user-3",userName:"王大明",userAvatar:"https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face",lastMessage:"想詢問一些當地的美食推薦",lastMessageTime:"2天前",unreadCount:1,isOnline:!0,serviceTitle:"台南古蹟巡禮 & 美食探索"}],N={"conv-1":[{id:"msg-1",content:"您好！我已經預訂了您的台北101導覽服務",senderId:"user-1",timestamp:"09:15",isRead:!0},{id:"msg-2",content:"您好！很高興為您服務。我會在約定時間準時到達集合點。",senderId:"guide-1",timestamp:"09:20",isRead:!0},{id:"msg-3",content:"請問明天的行程可以調整嗎？我想要多看一些歷史建築",senderId:"user-1",timestamp:"10:30",isRead:!1}]};(0,s.useEffect)(()=>{if(!i){e.push("/login");return}setTimeout(()=>{g(S),T(!1)},1e3)},[i,e]);let A=e=>{x(e),b(N[e]||[]),g(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t))},I=()=>{if(!v.trim()||!p)return;let e={id:"msg-".concat(Date.now()),content:v,senderId:"guide-1",timestamp:new Date().toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}),isRead:!0};b(t=>[...t,e]),j(""),g(e=>e.map(e=>e.id===p?{...e,lastMessage:v,lastMessageTime:"剛剛"}:e))},R=f.find(e=>e.id===p),z=f.reduce((e,t)=>e+t.unreadCount,0);return!i||C?(0,r.jsx)("div",{style:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,r.jsx)(h.gb,{size:"lg"})}):(0,r.jsx)("div",{style:{minHeight:"100vh",backgroundColor:"#f9fafb",padding:"1.5rem"},children:(0,r.jsxs)("div",{style:{maxWidth:"1400px",margin:"0 auto"},children:[(0,r.jsxs)("div",{style:{marginBottom:"2rem"},children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"0.5rem"},children:[(0,r.jsx)("h1",{style:{fontSize:"2rem",fontWeight:"700",color:"#111827"},children:"訊息中心"}),(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:z>0&&(0,r.jsxs)("div",{style:{padding:"0.25rem 0.75rem",backgroundColor:"#ef4444",color:"white",borderRadius:"9999px",fontSize:"0.875rem",fontWeight:"500"},children:[z," 則未讀"]})})]}),(0,r.jsx)("p",{style:{color:"#6b7280"},children:"與客戶即時溝通，提供優質服務體驗"})]}),(0,r.jsxs)("div",{style:{backgroundColor:"white",borderRadius:"1rem",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1)",border:"1px solid #e5e7eb",height:"80vh",display:"flex",overflow:"hidden"},children:[(0,r.jsxs)("div",{style:{width:"24rem",borderRight:"1px solid #e5e7eb",display:"flex",flexDirection:"column"},children:[(0,r.jsx)("div",{style:{padding:"1.5rem",borderBottom:"1px solid #e5e7eb"},children:(0,r.jsxs)("div",{style:{position:"relative"},children:[(0,r.jsx)(a.Z,{style:{position:"absolute",left:"0.75rem",top:"50%",transform:"translateY(-50%)",width:"1rem",height:"1rem",color:"#9ca3af"}}),(0,r.jsx)("input",{type:"text",placeholder:"搜尋對話...",value:w,onChange:e=>k(e.target.value),style:{width:"100%",paddingLeft:"2.5rem",padding:"0.75rem",border:"1px solid #e5e7eb",borderRadius:"0.5rem",fontSize:"0.875rem",outline:"none"},className:"focus:border-blue-500 focus:ring-2 focus:ring-blue-200"})]})}),(0,r.jsx)("div",{style:{flex:1,overflowY:"auto"},children:0===f.length?(0,r.jsxs)("div",{style:{padding:"2rem",textAlign:"center",color:"#6b7280"},children:[(0,r.jsx)(o.Z,{style:{width:"3rem",height:"3rem",margin:"0 auto 1rem",color:"#d1d5db"}}),(0,r.jsx)("p",{children:"暫無對話"}),(0,r.jsx)("p",{style:{fontSize:"0.875rem",marginTop:"0.5rem"},children:"當有客戶聯繫您時，對話會顯示在這裡"})]}):f.map(e=>(0,r.jsx)("div",{onClick:()=>A(e.id),style:{padding:"1rem",cursor:"pointer",borderBottom:"1px solid #f3f4f6",backgroundColor:p===e.id?"#eff6ff":"transparent",transition:"all 0.2s"},className:"hover:bg-gray-50",children:(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[(0,r.jsxs)("div",{style:{position:"relative"},children:[(0,r.jsx)("img",{src:e.userAvatar,alt:e.userName,style:{width:"3rem",height:"3rem",borderRadius:"50%",objectFit:"cover"}}),e.isOnline&&(0,r.jsx)("div",{style:{position:"absolute",bottom:"0",right:"0",width:"0.75rem",height:"0.75rem",backgroundColor:"#10b981",borderRadius:"50%",border:"2px solid white"}})]}),(0,r.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"0.25rem"},children:[(0,r.jsx)("h3",{style:{fontWeight:"600",color:"#111827",fontSize:"0.875rem"},children:e.userName}),(0,r.jsx)("span",{style:{fontSize:"0.75rem",color:"#6b7280"},children:e.lastMessageTime})]}),e.serviceTitle&&(0,r.jsx)("p",{style:{fontSize:"0.75rem",color:"#2563eb",marginBottom:"0.25rem"},children:e.serviceTitle}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,r.jsx)("p",{style:{fontSize:"0.875rem",color:"#6b7280",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"10rem"},children:e.lastMessage}),e.unreadCount>0&&(0,r.jsx)("div",{style:{backgroundColor:"#ef4444",color:"white",borderRadius:"50%",width:"1.25rem",height:"1.25rem",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:"600"},children:e.unreadCount})]})]})]})},e.id))})]}),(0,r.jsx)("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:R?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{style:{padding:"1rem 1.5rem",borderBottom:"1px solid #e5e7eb",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[(0,r.jsx)("img",{src:R.userAvatar,alt:R.userName,style:{width:"2.5rem",height:"2.5rem",borderRadius:"50%",objectFit:"cover"}}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{style:{fontWeight:"600",color:"#111827"},children:R.userName}),(0,r.jsx)("p",{style:{fontSize:"0.875rem",color:"#6b7280"},children:R.isOnline?"線上":"離線"})]})]}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[(0,r.jsx)("button",{style:{padding:"0.5rem",borderRadius:"0.5rem",border:"none",backgroundColor:"#f3f4f6",cursor:"pointer",transition:"all 0.2s"},className:"hover:bg-gray-300",children:(0,r.jsx)(l.Z,{style:{width:"1.25rem",height:"1.25rem",color:"#6b7280"}})}),(0,r.jsx)("button",{style:{padding:"0.5rem",borderRadius:"0.5rem",border:"none",backgroundColor:"#f3f4f6",cursor:"pointer",transition:"all 0.2s"},className:"hover:bg-gray-300",children:(0,r.jsx)(d.Z,{style:{width:"1.25rem",height:"1.25rem",color:"#6b7280"}})}),(0,r.jsx)("button",{style:{padding:"0.5rem",borderRadius:"0.5rem",border:"none",backgroundColor:"#f3f4f6",cursor:"pointer",transition:"all 0.2s"},className:"hover:bg-gray-300",children:(0,r.jsx)(c.Z,{style:{width:"1.25rem",height:"1.25rem",color:"#6b7280"}})})]})]}),(0,r.jsx)("div",{style:{flex:1,padding:"1.5rem",overflowY:"auto",display:"flex",flexDirection:"column",gap:"1rem"},children:y.map(e=>(0,r.jsx)("div",{style:{display:"flex",justifyContent:"guide-1"===e.senderId?"flex-end":"flex-start"},children:(0,r.jsxs)("div",{style:{maxWidth:"70%",padding:"0.75rem 1rem",borderRadius:"1rem",backgroundColor:"guide-1"===e.senderId?"#2563eb":"#f3f4f6",color:"guide-1"===e.senderId?"white":"#111827"},children:[(0,r.jsx)("p",{style:{margin:0,lineHeight:"1.5"},children:e.content}),(0,r.jsx)("p",{style:{margin:"0.25rem 0 0",fontSize:"0.75rem",opacity:.7,textAlign:"right"},children:e.timestamp})]})},e.id))}),(0,r.jsx)("div",{style:{padding:"1rem 1.5rem",borderTop:"1px solid #e5e7eb"},children:(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[(0,r.jsx)("input",{type:"text",placeholder:"輸入訊息...",value:v,onChange:e=>j(e.target.value),onKeyPress:e=>{"Enter"===e.key&&I()},style:{flex:1,padding:"0.75rem 1rem",border:"1px solid #e5e7eb",borderRadius:"9999px",fontSize:"0.875rem",outline:"none"},className:"focus:border-blue-500 focus:ring-2 focus:ring-blue-200"}),(0,r.jsx)("button",{onClick:I,disabled:!v.trim(),style:{padding:"0.75rem",backgroundColor:v.trim()?"#2563eb":"#d1d5db",color:"white",border:"none",borderRadius:"50%",cursor:v.trim()?"pointer":"not-allowed",transition:"all 0.2s"},children:(0,r.jsx)(u.Z,{style:{width:"1.25rem",height:"1.25rem"}})})]})})]}):(0,r.jsx)("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,r.jsxs)("div",{style:{textAlign:"center",color:"#6b7280"},children:[(0,r.jsx)(o.Z,{style:{width:"4rem",height:"4rem",margin:"0 auto 1rem",color:"#d1d5db"}}),(0,r.jsx)("h3",{style:{fontSize:"1.125rem",fontWeight:"600",marginBottom:"0.5rem"},children:"選擇對話開始聊天"}),(0,r.jsx)("p",{children:"從左側選擇一個對話來查看訊息"})]})})})]})]})})}},5022:function(e,t,i){"use strict";i.d(t,{gb:function(){return n}});var r=i(7437);i(2265);var s=i(2169);function n(e){let{size:t="md",variant:i="spinner",className:n,text:a}=e,o={sm:"w-4 h-4",md:"w-6 h-6",lg:"w-8 h-8"},l={sm:"text-sm",md:"text-base",lg:"text-lg"};return"spinner"===i?(0,r.jsxs)("div",{className:(0,s.cn)("flex flex-col items-center justify-center",n),children:[(0,r.jsx)("div",{className:(0,s.cn)("animate-spin rounded-full border-2 border-gray-300 border-t-[#FF5A5F]",o[t])}),a&&(0,r.jsx)("p",{className:(0,s.cn)("mt-2 text-gray-600",l[t]),children:a})]}):"dots"===i?(0,r.jsxs)("div",{className:(0,s.cn)("flex flex-col items-center justify-center",n),children:[(0,r.jsx)("div",{className:"flex space-x-1",children:[0,1,2].map(e=>(0,r.jsx)("div",{className:(0,s.cn)("bg-[#FF5A5F] rounded-full animate-pulse","sm"===t?"w-2 h-2":"md"===t?"w-3 h-3":"w-4 h-4"),style:{animationDelay:"".concat(.2*e,"s"),animationDuration:"1.2s"}},e))}),a&&(0,r.jsx)("p",{className:(0,s.cn)("mt-2 text-gray-600",l[t]),children:a})]}):"pulse"===i?(0,r.jsxs)("div",{className:(0,s.cn)("flex flex-col items-center justify-center",n),children:[(0,r.jsx)("div",{className:(0,s.cn)("bg-[#FF5A5F] rounded-full animate-pulse",o[t])}),a&&(0,r.jsx)("p",{className:(0,s.cn)("mt-2 text-gray-600",l[t]),children:a})]}):null}},2169:function(e,t,i){"use strict";i.d(t,{cn:function(){return n}});var r=i(7042),s=i(4769);function n(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return(0,s.m6)((0,r.W)(t))}},8228:function(e,t,i){"use strict";i.d(t,{a:function(){return n}});var r=i(4660),s=i(4810);let n=(0,r.Ue)()((0,s.tJ)((e,t)=>({user:null,token:null,refreshToken:null,isLoading:!1,isAuthenticated:!1,login:async(t,i)=>{e({isLoading:!0});try{var r,s,n,a;let o=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:t,password:i})}),l=await o.json();if(!o.ok||!l.success)throw Error(l.error||l.message||"登入失敗");let d={id:l.data.user.id,email:l.data.user.email,name:l.data.user.name,avatar:l.data.user.avatar,role:l.data.user.role.toLowerCase(),isEmailVerified:l.data.user.isEmailVerified,isKYCVerified:l.data.user.isKycVerified,createdAt:l.data.user.createdAt,permissions:l.data.user.permissions||[],profile:{phone:l.data.user.phone,bio:null===(r=l.data.user.userProfile)||void 0===r?void 0:r.bio,location:null===(s=l.data.user.userProfile)||void 0===s?void 0:s.location,languages:null===(n=l.data.user.userProfile)||void 0===n?void 0:n.languages,specialties:null===(a=l.data.user.userProfile)||void 0===a?void 0:a.specialties}};e({user:d,token:l.data.token,refreshToken:null,isAuthenticated:!0,isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},register:async t=>{e({isLoading:!0});try{await new Promise(e=>setTimeout(e,1500));let i={id:Date.now().toString(),email:t.email,name:t.name,role:t.userType||"customer",isEmailVerified:!1,isKYCVerified:!1,createdAt:new Date().toISOString(),permissions:"guide"===t.userType?["user:read","guide:manage","booking:manage"]:["user:read","booking:create"],profile:{phone:t.phone}},r="mock-jwt-token-"+Date.now();e({user:i,token:r,refreshToken:"mock-refresh-token",isAuthenticated:!0,isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},logout:async()=>{try{await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}catch(e){}e({user:null,token:null,refreshToken:null,isAuthenticated:!1})},updateUser:async i=>{let{user:r,token:s}=t();if(!r||!s)throw Error("未登入");e({isLoading:!0});try{let t=await fetch("/api/users/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)},body:JSON.stringify(i)});if(!t.ok)throw Error("更新失敗");let n=await t.json();e({user:{...r,...n},isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},refreshAuth:async()=>{let{refreshToken:i}=t();if(i)try{let t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:i})});if(!t.ok)throw Error("Token 刷新失敗");let r=await t.json();e({token:r.token,refreshToken:r.refreshToken})}catch(e){t().logout()}},initializeAuth:async()=>{try{let n=await fetch("/api/auth/me",{credentials:"include"});if(n.ok){let a=await n.json();if(a.success&&a.data.user){var t,i,r,s;let n={id:a.data.user.id,email:a.data.user.email,name:a.data.user.name,avatar:a.data.user.avatar,role:a.data.user.role.toLowerCase(),isEmailVerified:a.data.user.isEmailVerified,isKYCVerified:a.data.user.isKycVerified,createdAt:a.data.user.createdAt,permissions:a.data.user.permissions||[],profile:{phone:a.data.user.phone,bio:null===(t=a.data.user.userProfile)||void 0===t?void 0:t.bio,location:null===(i=a.data.user.userProfile)||void 0===i?void 0:i.location,languages:null===(r=a.data.user.userProfile)||void 0===r?void 0:r.languages,specialties:null===(s=a.data.user.userProfile)||void 0===s?void 0:s.specialties}};e({user:n,isAuthenticated:!0})}}}catch(e){}},setLoading:t=>{e({isLoading:t})},hasPermission:e=>{var i;let{user:r}=t();return!!r&&("GUIDE"===r.role||(null===(i=r.permissions)||void 0===i?void 0:i.includes(e))||!1)}}),{name:"guidee-auth",partialize:e=>({user:e.user,token:e.token,refreshToken:e.refreshToken,isAuthenticated:e.isAuthenticated})}))}},function(e){e.O(0,[1216,1744],function(){return e(e.s=8079)}),_N_E=e.O()}]);