(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2103,1248],{4572:function(e,t,s){Promise.resolve().then(s.bind(s,4655))},4655:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return N}});var a=s(7437),i=s(2265),r=s(4033),n=s(6369),l=s(2442),d=s(690),c=s(1827),o=s(3067),u=s(2741),m=s(8339),h=s(290),x=s(3714),g=s(8438),p=s(6489),f=s(6020),v=s(8228),y=s(7290),j=s(5022);function N(){let e=(0,r.useRouter)(),t=(0,r.useSearchParams)(),{user:s,isAuthenticated:N}=(0,v.a)(),{error:w}=(0,y.pm)(),[b,k]=(0,i.useState)([]),[F,T]=(0,i.useState)(null),[A,S]=(0,i.useState)([]),[I,Z]=(0,i.useState)(""),[C,L]=(0,i.useState)(""),[E,P]=(0,i.useState)(!0),[O,D]=(0,i.useState)(!1),[V,z]=(0,i.useState)(!1),K=(0,i.useRef)(null);(0,i.useEffect)(()=>{if(!N){e.push("/login");return}let s=t.get("guide");s&&J(s),_()},[N,e,t]),(0,i.useEffect)(()=>{let e=()=>{z(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,i.useEffect)(()=>{M()},[A]);let M=()=>{var e;null===(e=K.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},_=async()=>{P(!0);try{let a=[{id:"conv-1",participantId:"guide-1",participantName:"小美",participantAvatar:"https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face",participantRole:"guide",unreadCount:2,isOnline:!0,lastMessage:{id:"msg-1",content:"期待與您一起探索台北！",senderId:"guide-1",receiverId:(null==s?void 0:s.id)||"",timestamp:"2024-01-16T10:30:00Z",type:"text",status:"read"}},{id:"conv-2",participantId:"guide-2",participantName:"阿明",participantAvatar:"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face",participantRole:"guide",unreadCount:0,isOnline:!1,lastSeen:"2024-01-16T08:00:00Z",lastMessage:{id:"msg-2",content:"九份的行程我們明天確認",senderId:(null==s?void 0:s.id)||"",receiverId:"guide-2",timestamp:"2024-01-15T16:20:00Z",type:"text",status:"read"}}];if(k(a),!F&&a.length>0){var e,t;T((null===(e=a[0])||void 0===e?void 0:e.id)||null),(null===(t=a[0])||void 0===t?void 0:t.id)&&W(a[0].id)}}catch(e){w("載入失敗","無法載入對話列表")}finally{P(!1)}},W=async e=>{try{let e=[{id:"msg-1",content:"您好！我是小美，很高興為您提供台北導覽服務",senderId:"guide-1",receiverId:(null==s?void 0:s.id)||"",timestamp:"2024-01-16T09:00:00Z",type:"text",status:"read"},{id:"msg-2",content:"您好！我想詢問台北101的導覽行程",senderId:(null==s?void 0:s.id)||"",receiverId:"guide-1",timestamp:"2024-01-16T09:15:00Z",type:"text",status:"read"},{id:"msg-3",content:"沒問題！我可以為您安排4小時的深度導覽，包含台北101觀景台和信義商圈",senderId:"guide-1",receiverId:(null==s?void 0:s.id)||"",timestamp:"2024-01-16T09:18:00Z",type:"text",status:"read"},{id:"msg-4",content:"期待與您一起探索台北！",senderId:"guide-1",receiverId:(null==s?void 0:s.id)||"",timestamp:"2024-01-16T10:30:00Z",type:"text",status:"delivered"}];S(e)}catch(e){w("載入失敗","無法載入訊息")}},J=async e=>{let t=b.find(t=>t.participantId===e);t&&(T(t.id),W(t.id))},R=async()=>{var e;if(!I.trim()||!F||O)return;D(!0);let t={id:"msg-".concat(Date.now()),content:I.trim(),senderId:(null==s?void 0:s.id)||"",receiverId:(null===(e=b.find(e=>e.id===F))||void 0===e?void 0:e.participantId)||"",timestamp:new Date().toISOString(),type:"text",status:"sending"};S(e=>[...e,t]),Z("");try{await new Promise(e=>setTimeout(e,1e3)),S(e=>e.map(e=>e.id===t.id?{...e,status:"sent"}:e))}catch(e){S(e=>e.filter(e=>e.id!==t.id)),w("發送失敗","訊息發送失敗，請重試")}finally{D(!1)}},U=e=>{switch(e){case"sending":return(0,a.jsx)(n.Z,{className:"w-3 h-3 text-gray-400"});case"sent":return(0,a.jsx)(l.Z,{className:"w-3 h-3 text-gray-400"});case"delivered":return(0,a.jsx)(d.Z,{className:"w-3 h-3 text-gray-400"});case"read":return(0,a.jsx)(d.Z,{className:"w-3 h-3 text-blue-500"});default:return null}},Y=b.filter(e=>e.participantName.toLowerCase().includes(C.toLowerCase())),H=b.find(e=>e.id===F);return E?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,a.jsx)("div",{className:"container py-8",children:(0,a.jsx)("div",{className:"flex justify-center items-center py-20",children:(0,a.jsx)(j.gb,{size:"lg"})})})}):(0,a.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,a.jsxs)("div",{className:"container py-8",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"訊息中心"}),(0,a.jsx)("p",{className:"text-gray-600",children:"與地陪即時溝通，規劃完美行程"})]}),(0,a.jsx)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",style:{height:"600px"},children:(0,a.jsxs)("div",{className:"flex h-full",children:[(0,a.jsxs)("div",{className:"border-r border-gray-200 ".concat(V&&F?"hidden":"w-full md:w-1/3"),children:[(0,a.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(c.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsx)("input",{type:"text",placeholder:"搜尋對話...",value:C,onChange:e=>L(e.target.value),className:"w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#FF5A5F] focus:border-[#FF5A5F]"})]})}),(0,a.jsx)("div",{className:"overflow-y-auto",style:{height:"calc(100% - 73px)"},children:Y.length>0?(0,a.jsx)("div",{className:"divide-y divide-gray-200",children:Y.map(e=>{var t;return(0,a.jsx)("div",{onClick:()=>{T(e.id),W(e.id)},className:"p-4 cursor-pointer hover:bg-gray-50 transition-colors ".concat(F===e.id?"bg-blue-50 border-r-2 border-[#FF5A5F]":""),children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("img",{src:e.participantAvatar,alt:e.participantName,className:"w-12 h-12 rounded-full object-cover"}),e.isOnline&&(0,a.jsx)("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-900 truncate",children:e.participantName}),(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[e.lastMessage&&(0,a.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.lastMessage.timestamp).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"})}),e.unreadCount>0&&(0,a.jsx)("div",{className:"bg-[#FF5A5F] text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:e.unreadCount})]})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 truncate mt-1",children:(null===(t=e.lastMessage)||void 0===t?void 0:t.content)||"開始新對話"})]})]})},e.id)})}):(0,a.jsx)("div",{className:"p-8 text-center text-gray-500",children:(0,a.jsx)("p",{children:"沒有找到對話"})})})]}),(0,a.jsx)("div",{className:"flex flex-col ".concat(V&&!F?"hidden":"flex-1"),children:H?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[V&&(0,a.jsx)("button",{onClick:()=>T(null),className:"p-1 hover:bg-gray-200 rounded",children:(0,a.jsx)(o.Z,{className:"w-5 h-5"})}),(0,a.jsx)("img",{src:H.participantAvatar,alt:H.participantName,className:"w-10 h-10 rounded-full object-cover"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900",children:H.participantName}),(0,a.jsx)("p",{className:"text-sm text-gray-600",children:H.isOnline?"線上":"最後上線 ".concat(H.lastSeen?new Date(H.lastSeen).toLocaleString("zh-TW"):"未知")})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("button",{className:"p-2 hover:bg-gray-200 rounded-full",children:(0,a.jsx)(u.Z,{className:"w-5 h-5 text-gray-600"})}),(0,a.jsx)("button",{className:"p-2 hover:bg-gray-200 rounded-full",children:(0,a.jsx)(m.Z,{className:"w-5 h-5 text-gray-600"})}),(0,a.jsx)("button",{className:"p-2 hover:bg-gray-200 rounded-full",children:(0,a.jsx)(h.Z,{className:"w-5 h-5 text-gray-600"})})]})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",style:{height:"calc(100% - 140px)"},children:[A.map(e=>(0,a.jsx)("div",{className:"flex ".concat(e.senderId===(null==s?void 0:s.id)?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-xs lg:max-w-md px-4 py-2 rounded-lg ".concat(e.senderId===(null==s?void 0:s.id)?"bg-[#FF5A5F] text-white":"bg-gray-100 text-gray-900"),children:[(0,a.jsx)("p",{className:"text-sm",children:e.content}),(0,a.jsxs)("div",{className:"flex items-center justify-end mt-1 space-x-1 ".concat(e.senderId===(null==s?void 0:s.id)?"text-red-200":"text-gray-500"),children:[(0,a.jsx)("span",{className:"text-xs",children:new Date(e.timestamp).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"})}),e.senderId===(null==s?void 0:s.id)&&U(e.status)]})]})},e.id)),(0,a.jsx)("div",{ref:K})]}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-200 bg-gray-50",children:(0,a.jsxs)("div",{className:"flex items-end space-x-2",children:[(0,a.jsx)("button",{className:"p-2 text-gray-500 hover:text-gray-700",children:(0,a.jsx)(x.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{className:"p-2 text-gray-500 hover:text-gray-700",children:(0,a.jsx)(g.Z,{className:"w-5 h-5"})}),(0,a.jsx)("div",{className:"flex-1 relative",children:(0,a.jsx)("textarea",{value:I,onChange:e=>Z(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())},placeholder:"輸入訊息...",className:"w-full px-4 py-2 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-[#FF5A5F] focus:border-[#FF5A5F]",rows:1,style:{minHeight:"40px",maxHeight:"100px"}})}),(0,a.jsx)("button",{className:"p-2 text-gray-500 hover:text-gray-700",children:(0,a.jsx)(p.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:R,disabled:!I.trim()||O,className:"p-2 bg-[#FF5A5F] text-white rounded-lg hover:bg-[#E1464A] disabled:opacity-50 disabled:cursor-not-allowed",children:(0,a.jsx)(f.Z,{className:"w-5 h-5"})})]})})]}):(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center text-gray-500",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(f.Z,{className:"w-8 h-8 text-gray-400"})}),(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"選擇對話開始聊天"}),(0,a.jsx)("p",{className:"text-gray-600",children:"與地陪即時溝通，規劃完美的旅行體驗"})]})})})]})})]})})}},5022:function(e,t,s){"use strict";s.d(t,{gb:function(){return r}});var a=s(7437);s(2265);var i=s(2169);function r(e){let{size:t="md",variant:s="spinner",className:r,text:n}=e,l={sm:"w-4 h-4",md:"w-6 h-6",lg:"w-8 h-8"},d={sm:"text-sm",md:"text-base",lg:"text-lg"};return"spinner"===s?(0,a.jsxs)("div",{className:(0,i.cn)("flex flex-col items-center justify-center",r),children:[(0,a.jsx)("div",{className:(0,i.cn)("animate-spin rounded-full border-2 border-gray-300 border-t-[#FF5A5F]",l[t])}),n&&(0,a.jsx)("p",{className:(0,i.cn)("mt-2 text-gray-600",d[t]),children:n})]}):"dots"===s?(0,a.jsxs)("div",{className:(0,i.cn)("flex flex-col items-center justify-center",r),children:[(0,a.jsx)("div",{className:"flex space-x-1",children:[0,1,2].map(e=>(0,a.jsx)("div",{className:(0,i.cn)("bg-[#FF5A5F] rounded-full animate-pulse","sm"===t?"w-2 h-2":"md"===t?"w-3 h-3":"w-4 h-4"),style:{animationDelay:"".concat(.2*e,"s"),animationDuration:"1.2s"}},e))}),n&&(0,a.jsx)("p",{className:(0,i.cn)("mt-2 text-gray-600",d[t]),children:n})]}):"pulse"===s?(0,a.jsxs)("div",{className:(0,i.cn)("flex flex-col items-center justify-center",r),children:[(0,a.jsx)("div",{className:(0,i.cn)("bg-[#FF5A5F] rounded-full animate-pulse",l[t])}),n&&(0,a.jsx)("p",{className:(0,i.cn)("mt-2 text-gray-600",d[t]),children:n})]}):null}},7290:function(e,t,s){"use strict";s.d(t,{pm:function(){return d}}),s(7437);var a=s(2265),i=s(3008),r=s(1981),n=s(2894),l=s(4056);function d(){let[e,t]=(0,a.useState)([]),s=e=>{let s=Math.random().toString(36).substr(2,9),a={id:s,duration:5e3,...e};return t(e=>[...e,a]),s};return{toasts:e,addToast:s,removeToast:e=>{t(t=>t.filter(t=>t.id!==e))},success:(e,t)=>s({type:"success",title:e,message:t}),error:(e,t)=>s({type:"error",title:e,message:t}),warning:(e,t)=>s({type:"warning",title:e,message:t}),info:(e,t)=>s({type:"info",title:e,message:t})}}i.Z,r.Z,n.Z,l.Z},2169:function(e,t,s){"use strict";s.d(t,{cn:function(){return r}});var a=s(7042),i=s(4769);function r(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,i.m6)((0,a.W)(t))}},8228:function(e,t,s){"use strict";s.d(t,{a:function(){return r}});var a=s(4660),i=s(4810);let r=(0,a.Ue)()((0,i.tJ)((e,t)=>({user:null,token:null,refreshToken:null,isLoading:!1,isAuthenticated:!1,login:async(t,s)=>{e({isLoading:!0});try{var a,i,r,n;let l=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:t,password:s})}),d=await l.json();if(!l.ok||!d.success)throw Error(d.error||d.message||"登入失敗");let c={id:d.data.user.id,email:d.data.user.email,name:d.data.user.name,avatar:d.data.user.avatar,role:d.data.user.role.toLowerCase(),isEmailVerified:d.data.user.isEmailVerified,isKYCVerified:d.data.user.isKycVerified,createdAt:d.data.user.createdAt,permissions:d.data.user.permissions||[],profile:{phone:d.data.user.phone,bio:null===(a=d.data.user.userProfile)||void 0===a?void 0:a.bio,location:null===(i=d.data.user.userProfile)||void 0===i?void 0:i.location,languages:null===(r=d.data.user.userProfile)||void 0===r?void 0:r.languages,specialties:null===(n=d.data.user.userProfile)||void 0===n?void 0:n.specialties}};e({user:c,token:d.data.token,refreshToken:null,isAuthenticated:!0,isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},register:async t=>{e({isLoading:!0});try{await new Promise(e=>setTimeout(e,1500));let s={id:Date.now().toString(),email:t.email,name:t.name,role:t.userType||"customer",isEmailVerified:!1,isKYCVerified:!1,createdAt:new Date().toISOString(),permissions:"guide"===t.userType?["user:read","guide:manage","booking:manage"]:["user:read","booking:create"],profile:{phone:t.phone}},a="mock-jwt-token-"+Date.now();e({user:s,token:a,refreshToken:"mock-refresh-token",isAuthenticated:!0,isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},logout:async()=>{try{await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}catch(e){}e({user:null,token:null,refreshToken:null,isAuthenticated:!1})},updateUser:async s=>{let{user:a,token:i}=t();if(!a||!i)throw Error("未登入");e({isLoading:!0});try{let t=await fetch("/api/users/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(i)},body:JSON.stringify(s)});if(!t.ok)throw Error("更新失敗");let r=await t.json();e({user:{...a,...r},isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},refreshAuth:async()=>{let{refreshToken:s}=t();if(s)try{let t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:s})});if(!t.ok)throw Error("Token 刷新失敗");let a=await t.json();e({token:a.token,refreshToken:a.refreshToken})}catch(e){t().logout()}},initializeAuth:async()=>{try{let r=await fetch("/api/auth/me",{credentials:"include"});if(r.ok){let n=await r.json();if(n.success&&n.data.user){var t,s,a,i;let r={id:n.data.user.id,email:n.data.user.email,name:n.data.user.name,avatar:n.data.user.avatar,role:n.data.user.role.toLowerCase(),isEmailVerified:n.data.user.isEmailVerified,isKYCVerified:n.data.user.isKycVerified,createdAt:n.data.user.createdAt,permissions:n.data.user.permissions||[],profile:{phone:n.data.user.phone,bio:null===(t=n.data.user.userProfile)||void 0===t?void 0:t.bio,location:null===(s=n.data.user.userProfile)||void 0===s?void 0:s.location,languages:null===(a=n.data.user.userProfile)||void 0===a?void 0:a.languages,specialties:null===(i=n.data.user.userProfile)||void 0===i?void 0:i.specialties}};e({user:r,isAuthenticated:!0})}}}catch(e){}},setLoading:t=>{e({isLoading:t})},hasPermission:e=>{var s;let{user:a}=t();return!!a&&("GUIDE"===a.role||(null===(s=a.permissions)||void 0===s?void 0:s.includes(e))||!1)}}),{name:"guidee-auth",partialize:e=>({user:e.user,token:e.token,refreshToken:e.refreshToken,isAuthenticated:e.isAuthenticated})}))}},function(e){e.O(0,[1216,1744],function(){return e(e.s=4572)}),_N_E=e.O()}]);