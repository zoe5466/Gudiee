"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6828],{6828:function(e,t,r){r.d(t,{f:function(){return h}});var s=r(7437),i=r(2265),a=r(2741),n=r(8339),o=r(7472),d=r(2549),l=r(3714),c=r(6020),u=r(8228);class m{on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(e=>e!==t))}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(e=>e(t))}send(e){this.connected&&(setTimeout(()=>{this.emit("message",{data:JSON.stringify({type:"status",messageId:JSON.parse(e).messageId,status:"delivered"})})},500),"support"===JSON.parse(e).recipient&&Math.random()>.3&&setTimeout(()=>{let e=["我了解您的問題，讓我為您查詢一下。","感謝您的詢問，我會盡快為您處理。","請稍等，我正在為您安排相關人員。","這個問題很常見，讓我為您詳細說明。"];this.emit("message",{data:JSON.stringify({type:"message",data:{id:"reply-".concat(Date.now()),content:e[Math.floor(Math.random()*e.length)],timestamp:new Date().toISOString(),sender:{id:"support",name:"客服中心",role:"support"},type:"text",status:"sent"}})})},1e3+2e3*Math.random()))}close(){this.connected=!1,this.emit("close")}get readyState(){return this.connected?1:0}constructor(e){this.listeners={},this.connected=!1,setTimeout(()=>{this.connected=!0,this.emit("open"),e.includes("support")&&setTimeout(()=>{this.emit("message",{data:JSON.stringify({type:"message",data:{id:"auto-reply-1",content:"您好！我是 Guidee 客服，有什麼可以幫助您的嗎？",timestamp:new Date().toISOString(),sender:{id:"support",name:"客服中心",role:"support"},type:"text",status:"sent"}})})},1e3)},500)}}function h(e){let{recipientId:t,recipientName:r,recipientAvatar:h,chatType:g,onClose:f,className:p=""}=e,{user:y}=(0,u.a)(),{messages:b,isConnected:x,isLoading:v,sendMessage:w,markAsRead:k,startTyping:j,stopTyping:C}=function(e,t){let{user:r}=(0,u.a)(),[s,a]=(0,i.useState)({messages:[],isConnected:!1,isLoading:!0,unreadCount:0}),n=(0,i.useRef)(null),o=(0,i.useRef)(null);(0,i.useEffect)(()=>{if(!r)return;let s=new m("ws://localhost:3001/chat/".concat(t,"/").concat(e));n.current=s;let i=()=>{a(e=>({...e,isConnected:!0,isLoading:!1}))},o=e=>{try{let t=JSON.parse(e.data);switch(t.type){case"message":let s={...t.data,timestamp:new Date(t.data.timestamp)};a(e=>({...e,messages:[...e.messages,s],unreadCount:s.sender.id!==r.id?e.unreadCount+1:e.unreadCount}));break;case"status":a(e=>({...e,messages:e.messages.map(e=>e.id===t.messageId?{...e,status:t.status}:e)}))}}catch(e){}},d=()=>{a(e=>({...e,isConnected:!1}))},l=e=>{a(e=>({...e,isConnected:!1,isLoading:!1}))};return s.on("open",i),s.on("message",o),s.on("close",d),s.on("error",l),()=>{s.off("open",i),s.off("message",o),s.off("close",d),s.off("error",l),s.close()}},[r,e,t]);let d=(0,i.useCallback)(async t=>{var s;if(!n.current||!r)return;let i="msg-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),o={id:i,content:t.content,timestamp:new Date,sender:{id:r.id,name:r.name,avatar:null===(s=r.profile)||void 0===s?void 0:s.avatar,role:"guide"===r.role?"guide":"user"},type:t.type,status:"sending",metadata:t.metadata};a(e=>({...e,messages:[...e.messages,o]}));try{n.current.send(JSON.stringify({messageId:i,recipient:e,content:t.content,type:t.type,metadata:t.metadata})),setTimeout(()=>{a(e=>({...e,messages:e.messages.map(e=>e.id===i?{...e,status:"sent"}:e)}))},100)}catch(e){throw a(e=>({...e,messages:e.messages.map(e=>e.id===i?{...e,status:"sending"}:e)})),e}},[r,e]),l=(0,i.useCallback)(()=>{a(e=>({...e,unreadCount:0,messages:e.messages.map(e=>e.sender.id!==(null==r?void 0:r.id)&&"read"!==e.status?{...e,status:"read"}:e)}))},[r]),c=(0,i.useCallback)(()=>{n.current&&(o.current&&clearTimeout(o.current),n.current.send(JSON.stringify({type:"typing",recipient:e,isTyping:!0})),o.current=setTimeout(()=>{h()},3e3))},[e]),h=(0,i.useCallback)(()=>{n.current&&(o.current&&(clearTimeout(o.current),o.current=null),n.current.send(JSON.stringify({type:"typing",recipient:e,isTyping:!1})))},[e]);return(0,i.useEffect)(()=>()=>{o.current&&clearTimeout(o.current)},[]),{messages:s.messages,isConnected:s.isConnected,isLoading:s.isLoading,unreadCount:s.unreadCount,sendMessage:d,markAsRead:l,startTyping:c,stopTyping:h}}(t,g),[S,T]=(0,i.useState)(""),[I,D]=(0,i.useState)(!1),N=(0,i.useRef)(null),A=(0,i.useRef)(null);(0,i.useEffect)(()=>{var e;null===(e=N.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[b]),(0,i.useEffect)(()=>{k()},[b,k]);let L=e=>{T(e),e.trim()&&!I?(D(!0),j()):!e.trim()&&I&&(D(!1),C())},R=async()=>{let e=S.trim();if(e)try{var t;await w({content:e,type:"text"}),T(""),D(!1),C(),null===(t=A.current)||void 0===t||t.focus()}catch(e){}},O=e=>new Intl.DateTimeFormat("zh-TW",{hour:"2-digit",minute:"2-digit"}).format(e),z=e=>{let t=new Date,r=new Date(e);if(r.toDateString()===t.toDateString())return"今天";let s=new Date(t);return(s.setDate(s.getDate()-1),r.toDateString()===s.toDateString())?"昨天":new Intl.DateTimeFormat("zh-TW",{month:"long",day:"numeric"}).format(r)},E=e=>{switch(e){case"sending":return(0,s.jsx)("div",{style:{width:"0.75rem",height:"0.75rem",border:"1px solid #9ca3af",borderTop:"1px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}});case"sent":return(0,s.jsx)("span",{style:{color:"#9ca3af"},children:"✓"});case"delivered":return(0,s.jsx)("span",{style:{color:"#3b82f6"},children:"✓✓"});case"read":return(0,s.jsx)("span",{style:{color:"#10b981"},children:"✓✓"});default:return null}};return v?(0,s.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"400px",backgroundColor:"#f9fafb",borderRadius:"0.5rem"},children:(0,s.jsxs)("div",{style:{textAlign:"center",color:"#6b7280"},children:[(0,s.jsx)("div",{style:{width:"2rem",height:"2rem",border:"2px solid #e5e7eb",borderTop:"2px solid #3b82f6",borderRadius:"50%",animation:"spin 1s linear infinite",margin:"0 auto 0.5rem"}}),"連接聊天室中..."]})}):(0,s.jsxs)("div",{style:{display:"flex",flexDirection:"column",height:"500px",backgroundColor:"white",borderRadius:"0.5rem",border:"1px solid #e5e7eb",overflow:"hidden"},className:p,children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"1rem",backgroundColor:"#f8fafc",borderBottom:"1px solid #e5e7eb"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[(0,s.jsx)("div",{style:{width:"2.5rem",height:"2.5rem",backgroundColor:h?"transparent":"#e5e7eb",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1rem",fontWeight:"600",color:"#6b7280",backgroundImage:h?"url(".concat(h,")"):void 0,backgroundSize:"cover",backgroundPosition:"center"},children:!h&&r.charAt(0).toUpperCase()}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{style:{fontSize:"0.875rem",fontWeight:"600",color:"#111827"},children:r}),(0,s.jsxs)("div",{style:{fontSize:"0.75rem",color:x?"#10b981":"#ef4444",display:"flex",alignItems:"center",gap:"0.25rem"},children:[(0,s.jsx)("div",{style:{width:"0.5rem",height:"0.5rem",backgroundColor:x?"#10b981":"#ef4444",borderRadius:"50%"}}),x?"線上":"離線"]})]})]}),(0,s.jsxs)("div",{style:{display:"flex",gap:"0.5rem"},children:[(0,s.jsx)("button",{style:{width:"2rem",height:"2rem",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"transparent",border:"none",borderRadius:"0.25rem",cursor:"pointer"},className:"hover:bg-gray-200",children:(0,s.jsx)(a.Z,{style:{width:"1rem",height:"1rem",color:"#6b7280"}})}),(0,s.jsx)("button",{style:{width:"2rem",height:"2rem",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"transparent",border:"none",borderRadius:"0.25rem",cursor:"pointer"},className:"hover:bg-gray-200",children:(0,s.jsx)(n.Z,{style:{width:"1rem",height:"1rem",color:"#6b7280"}})}),(0,s.jsx)("button",{style:{width:"2rem",height:"2rem",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"transparent",border:"none",borderRadius:"0.25rem",cursor:"pointer"},className:"hover:bg-gray-200",children:(0,s.jsx)(o.Z,{style:{width:"1rem",height:"1rem",color:"#6b7280"}})}),f&&(0,s.jsx)("button",{onClick:f,style:{width:"2rem",height:"2rem",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"transparent",border:"none",borderRadius:"0.25rem",cursor:"pointer"},className:"hover:bg-gray-200",children:(0,s.jsx)(d.Z,{style:{width:"1rem",height:"1rem",color:"#6b7280"}})})]})]}),(0,s.jsx)("div",{style:{flex:1,overflowY:"auto",padding:"1rem",backgroundColor:"#f9fafb"},children:0===b.length?(0,s.jsx)("div",{style:{textAlign:"center",color:"#6b7280",fontSize:"0.875rem",marginTop:"2rem"},children:"開始對話吧！"}):(0,s.jsxs)(s.Fragment,{children:[b.map((e,t)=>{var r;let i=e.sender.id===(null==y?void 0:y.id),a=0===t||z((null===(r=b[t-1])||void 0===r?void 0:r.timestamp)||new Date)!==z(e.timestamp);return(0,s.jsxs)("div",{children:[a&&(0,s.jsx)("div",{style:{textAlign:"center",margin:"1rem 0 0.5rem",fontSize:"0.75rem",color:"#9ca3af"},children:z(e.timestamp)}),(0,s.jsxs)("div",{style:{display:"flex",flexDirection:i?"row-reverse":"row",alignItems:"flex-end",gap:"0.5rem",marginBottom:"0.75rem"},children:[!i&&(0,s.jsx)("div",{style:{width:"1.75rem",height:"1.75rem",backgroundColor:e.sender.avatar?"transparent":"#e5e7eb",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:"600",color:"#6b7280",backgroundImage:e.sender.avatar?"url(".concat(e.sender.avatar,")"):void 0,backgroundSize:"cover",backgroundPosition:"center",flexShrink:0},children:!e.sender.avatar&&e.sender.name.charAt(0).toUpperCase()}),(0,s.jsxs)("div",{style:{maxWidth:"70%",display:"flex",flexDirection:"column",alignItems:i?"flex-end":"flex-start"},children:[(0,s.jsx)("div",{style:{padding:"0.75rem 1rem",backgroundColor:i?"#3b82f6":"white",color:i?"white":"#111827",borderRadius:i?"1rem 1rem 0.25rem 1rem":"1rem 1rem 1rem 0.25rem",border:i?"none":"1px solid #e5e7eb",fontSize:"0.875rem",lineHeight:"1.5",wordBreak:"break-word"},children:e.content}),(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"0.25rem",marginTop:"0.25rem",fontSize:"0.75rem",color:"#9ca3af"},children:[(0,s.jsx)("span",{children:O(e.timestamp)}),i&&E(e.status)]})]})]})]},e.id)}),(0,s.jsx)("div",{ref:N})]})}),(0,s.jsx)("div",{style:{padding:"1rem",backgroundColor:"white",borderTop:"1px solid #e5e7eb"},children:(0,s.jsxs)("div",{style:{display:"flex",alignItems:"flex-end",gap:"0.5rem"},children:[(0,s.jsx)("button",{style:{padding:"0.5rem",backgroundColor:"transparent",border:"none",borderRadius:"0.25rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},className:"hover:bg-gray-100",children:(0,s.jsx)(l.Z,{style:{width:"1.25rem",height:"1.25rem",color:"#6b7280"}})}),(0,s.jsx)("div",{style:{flex:1,position:"relative"},children:(0,s.jsx)("textarea",{ref:A,value:S,onChange:e=>L(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())},placeholder:"輸入訊息...",style:{width:"100%",maxHeight:"6rem",padding:"0.75rem",border:"1px solid #e5e7eb",borderRadius:"1.5rem",fontSize:"0.875rem",resize:"none",outline:"none",backgroundColor:"#f9fafb"},className:"focus:border-blue-500 focus:ring-1 focus:ring-blue-500",rows:1,disabled:!x})}),(0,s.jsx)("button",{onClick:R,disabled:!S.trim()||!x,style:{padding:"0.75rem",backgroundColor:S.trim()&&x?"#3b82f6":"#e5e7eb",border:"none",borderRadius:"50%",cursor:S.trim()&&x?"pointer":"not-allowed",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s"},className:"hover:scale-105",children:(0,s.jsx)(c.Z,{style:{width:"1.125rem",height:"1.125rem",color:S.trim()&&x?"white":"#9ca3af"}})})]})})]})}},8228:function(e,t,r){r.d(t,{a:function(){return a}});var s=r(4660),i=r(4810);let a=(0,s.Ue)()((0,i.tJ)((e,t)=>({user:null,token:null,refreshToken:null,isLoading:!1,isAuthenticated:!1,login:async(t,r)=>{e({isLoading:!0});try{var s,i,a,n;let o=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:t,password:r})}),d=await o.json();if(!o.ok||!d.success)throw Error(d.error||d.message||"登入失敗");let l={id:d.data.user.id,email:d.data.user.email,name:d.data.user.name,avatar:d.data.user.avatar,role:d.data.user.role.toLowerCase(),isEmailVerified:d.data.user.isEmailVerified,isKYCVerified:d.data.user.isKycVerified,createdAt:d.data.user.createdAt,permissions:d.data.user.permissions||[],profile:{phone:d.data.user.phone,bio:null===(s=d.data.user.userProfile)||void 0===s?void 0:s.bio,location:null===(i=d.data.user.userProfile)||void 0===i?void 0:i.location,languages:null===(a=d.data.user.userProfile)||void 0===a?void 0:a.languages,specialties:null===(n=d.data.user.userProfile)||void 0===n?void 0:n.specialties}};e({user:l,token:d.data.token,refreshToken:null,isAuthenticated:!0,isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},register:async t=>{e({isLoading:!0});try{await new Promise(e=>setTimeout(e,1500));let r={id:Date.now().toString(),email:t.email,name:t.name,role:t.userType||"customer",isEmailVerified:!1,isKYCVerified:!1,createdAt:new Date().toISOString(),permissions:"guide"===t.userType?["user:read","guide:manage","booking:manage"]:["user:read","booking:create"],profile:{phone:t.phone}},s="mock-jwt-token-"+Date.now();e({user:r,token:s,refreshToken:"mock-refresh-token",isAuthenticated:!0,isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},logout:async()=>{try{await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}catch(e){}e({user:null,token:null,refreshToken:null,isAuthenticated:!1})},updateUser:async r=>{let{user:s,token:i}=t();if(!s||!i)throw Error("未登入");e({isLoading:!0});try{let t=await fetch("/api/users/profile",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(i)},body:JSON.stringify(r)});if(!t.ok)throw Error("更新失敗");let a=await t.json();e({user:{...s,...a},isLoading:!1})}catch(t){throw e({isLoading:!1}),t}},refreshAuth:async()=>{let{refreshToken:r}=t();if(r)try{let t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:r})});if(!t.ok)throw Error("Token 刷新失敗");let s=await t.json();e({token:s.token,refreshToken:s.refreshToken})}catch(e){t().logout()}},initializeAuth:async()=>{try{let a=await fetch("/api/auth/me",{credentials:"include"});if(a.ok){let n=await a.json();if(n.success&&n.data.user){var t,r,s,i;let a={id:n.data.user.id,email:n.data.user.email,name:n.data.user.name,avatar:n.data.user.avatar,role:n.data.user.role.toLowerCase(),isEmailVerified:n.data.user.isEmailVerified,isKYCVerified:n.data.user.isKycVerified,createdAt:n.data.user.createdAt,permissions:n.data.user.permissions||[],profile:{phone:n.data.user.phone,bio:null===(t=n.data.user.userProfile)||void 0===t?void 0:t.bio,location:null===(r=n.data.user.userProfile)||void 0===r?void 0:r.location,languages:null===(s=n.data.user.userProfile)||void 0===s?void 0:s.languages,specialties:null===(i=n.data.user.userProfile)||void 0===i?void 0:i.specialties}};e({user:a,isAuthenticated:!0})}}}catch(e){}},setLoading:t=>{e({isLoading:t})},hasPermission:e=>{var r;let{user:s}=t();return!!s&&("admin"===s.role||(null===(r=s.permissions)||void 0===r?void 0:r.includes(e))||!1)}}),{name:"guidee-auth",partialize:e=>({user:e.user,token:e.token,refreshToken:e.refreshToken,isAuthenticated:e.isAuthenticated})}))}}]);