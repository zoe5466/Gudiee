"use strict";(()=>{var e={};e.id=9353,e.ids=[9353],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},70671:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{POST:()=>l});var a=r(95419),s=r(69108),i=r(99678),o=r(34490),u=r(82002),c=r(59413);async function l(e){try{let t=await (0,u.ts)();if(!t)return(0,c.m)();let{bookingId:r,paymentMethod:n,cardDetails:a}=await e.json(),s={};if(r||(s.bookingId="預訂 ID 為必填項目"),n||(s.paymentMethod="支付方式為必填項目"),Object.keys(s).length>0)return(0,c.sm)(s);let i=await o._.booking.findUnique({where:{id:r},include:{service:{include:{guide:{select:{id:!0,name:!0,email:!0}}}},traveler:{select:{id:!0,name:!0,email:!0}}}});if(!i)return(0,c.VR)("找不到預訂",404);if(i.travelerId!==t.id)return(0,c.VR)("無權限訪問此預訂",403);if("PENDING"!==i.paymentStatus)return(0,c.VR)("此預訂已處理過付款",400);let l=`tx_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=await o._.payment.create({data:{bookingId:i.id,userId:t.id,amount:i.totalAmount,currency:i.currency,status:"COMPLETED",metadata:{paymentMethod:n,transactionId:l,processedAt:new Date().toISOString()},processedAt:new Date}}),p=await o._.booking.update({where:{id:r},data:{paymentStatus:"COMPLETED",status:"CONFIRMED",paymentIntentId:l},include:{service:{include:{guide:{select:{id:!0,name:!0,email:!0}}}},traveler:{select:{id:!0,name:!0,email:!0}},payments:!0}});return(0,c.Xj)({status:"succeeded",transactionId:l,booking:p,payment:d},"支付成功！預訂已確認")}catch(e){return(0,c.VR)("支付處理失敗",500)}}let d=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/bookings/payment/route",pathname:"/api/bookings/payment",filename:"route",bundlePath:"app/api/bookings/payment/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/bookings/payment/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:f,staticGenerationBailout:y}=d,h="/api/bookings/payment/route";function v(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},59413:(e,t,r)=>{r.d(t,{VR:()=>s,Xj:()=>a,aX:()=>o,m:()=>i,ql:()=>c,sm:()=>u});var n=r(78070);function a(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function s(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function i(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>m});var n=r(6521),a=r.n(n),s=r(46082),i=r.n(s),o=r(32455),u=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return a().hash(e,12)}async function d(e,t){return a().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return i().sign(t,c,{expiresIn:"7d"})}async function m(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return i().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await u._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>a});var n=r(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(70671));module.exports=n})();