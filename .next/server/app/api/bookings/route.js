"use strict";(()=>{var e={};e.id=1946,e.ids=[1946],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},72738:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>h,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{GET:()=>l,POST:()=>d});var a=r(95419),i=r(69108),s=r(99678),o=r(34490),u=r(82002),c=r(59413);async function l(e){try{let t=await (0,u.ts)();if(!t)return(0,c.m)();let{searchParams:r}=new URL(e.url),n=r.get("status"),a=r.get("role"),i=parseInt(r.get("page")||"1"),s=parseInt(r.get("limit")||"10"),l=(i-1)*s,d={};n&&(d.status=n),"CUSTOMER"===t.role||"customer"===a?d.travelerId=t.id:"GUIDE"===t.role||"guide"===a?d.guideId=t.id:"ADMIN"===t.role||(d.travelerId=t.id);let[p,g]=await Promise.all([o._.booking.findMany({where:d,include:{service:{include:{guide:{select:{id:!0,name:!0,email:!0,avatar:!0}}}},traveler:{select:{id:!0,name:!0,email:!0,avatar:!0}},payments:!0},orderBy:{createdAt:"desc"},skip:l,take:s}),o._.booking.count({where:d})]),m=Math.ceil(g/s);return(0,c.Xj)(p,"預訂列表獲取成功",{page:i,limit:s,total:g,totalPages:m})}catch(e){return(0,c.VR)("獲取預訂列表失敗",500)}}async function d(e){try{let t=await (0,u.ts)();if(!t)return(0,c.m)();let{serviceId:r,bookingDate:n,totalPrice:a,guests:i,specialRequests:s,contactInfo:l}=await e.json(),d={};if(r||(d.serviceId="服務 ID 為必填項目"),n||(d.bookingDate="預訂日期為必填項目"),(!a||a<=0)&&(d.totalPrice="總金額必須大於 0"),(!i||i<=0)&&(d.guests="參與人數必須大於 0"),Object.keys(d).length>0)return(0,c.sm)(d);let p=await o._.service.findUnique({where:{id:r},include:{guide:{select:{id:!0,name:!0,email:!0}}}});if(!p)return(0,c.VR)("服務不存在",404);if("ACTIVE"!==p.status)return(0,c.VR)("服務目前不可預訂",400);if(i>p.maxGuests)return(0,c.VR)(`參與人數不能超過 ${p.maxGuests} 人`,400);if(i<p.minGuests)return(0,c.VR)(`參與人數不能少於 ${p.minGuests} 人`,400);if(await o._.booking.findFirst({where:{serviceId:r,bookingDate:new Date(n),status:{in:["PENDING","CONFIRMED"]}}}))return(0,c.VR)("該日期時段已被預訂",409);let g=await o._.booking.create({data:{serviceId:r,travelerId:t.id,guideId:p.guideId,bookingDate:new Date(n),startTime:new Date(`${n}T09:00:00`),durationHours:p.durationHours,guests:parseInt(i.toString()),basePrice:parseFloat(a.toString()),serviceFee:parseFloat((.1*a).toString()),totalAmount:parseFloat((1.1*a).toString()),currency:p.currency||"TWD",specialRequests:s||null,contactInfo:l||{},status:"PENDING",paymentStatus:"PENDING"},include:{service:{include:{guide:{select:{id:!0,name:!0,email:!0,avatar:!0}}}},traveler:{select:{id:!0,name:!0,email:!0,avatar:!0}}}});return(0,c.Xj)(g,"預訂創建成功")}catch(e){return(0,c.VR)("創建預訂失敗",500)}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bookings/route",pathname:"/api/bookings",filename:"route",bundlePath:"app/api/bookings/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/bookings/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f,headerHooks:v,staticGenerationBailout:y}=p,h="/api/bookings/route";function x(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},59413:(e,t,r)=>{r.d(t,{VR:()=>i,Xj:()=>a,aX:()=>o,m:()=>s,ql:()=>c,sm:()=>u});var n=r(78070);function a(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function i(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function s(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>g});var n=r(6521),a=r.n(n),i=r(46082),s=r.n(i),o=r(32455),u=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return a().hash(e,12)}async function d(e,t){return a().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return s().sign(t,c,{expiresIn:"7d"})}async function g(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return s().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await u._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>a});var n=r(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(72738));module.exports=n})();