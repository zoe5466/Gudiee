"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},15107:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>x});var s={};t.r(s),t.d(s,{POST:()=>d});var a=t(95419),i=t(69108),n=t(99678),u=t(32455),o=t(34490),c=t(82002),l=t(59413);async function d(e){try{let{email:r,password:t,name:s,userType:a,phone:i,subscribeNewsletter:n}=await e.json(),d={};if(r||(d.email="Email 為必填項目"),t||(d.password="密碼為必填項目"),s||(d.name="姓名為必填項目"),r&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)&&(d.email="請提供有效的 Email 地址"),t&&(t.length<8?d.password="密碼必須至少 8 個字符":/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(t)||(d.password="密碼必須包含大小寫字母和數字")),Object.keys(d).length>0)return(0,l.sm)(d);if(await o._.user.findUnique({where:{email:r.toLowerCase()}}))return(0,l.VR)("此 Email 已被註冊",409);let p=await (0,c.c_)(t),m="guide"===a?"GUIDE":"CUSTOMER",f=await o._.user.create({data:{email:r.toLowerCase(),passwordHash:p,name:s,phone:i||null,role:m,isEmailVerified:!1,isKycVerified:!1,permissions:"GUIDE"===m?["user:read","guide:manage","booking:manage"]:["user:read","booking:create"],settings:{subscribeNewsletter:n||!1,notifications:{email:!0,push:!0,sms:!1}}},include:{userProfile:!0}});"GUIDE"===m&&await o._.userProfile.create({data:{userId:f.id,bio:"",location:"",languages:[],specialties:[],experienceYears:null,certifications:[],socialLinks:{}}});let g=(0,c.RA)(f);(0,u.cookies)().set("auth-token",g,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800});let{passwordHash:h,...x}=f;return(0,l.Xj)({user:x,token:g},"註冊成功，歡迎加入 Guidee！")}catch(e){return(0,l.VR)("註冊失敗，請稍後再試",500)}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/auth/register/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:h,staticGenerationBailout:x}=p,y="/api/auth/register/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},59413:(e,r,t)=>{t.d(r,{VR:()=>i,Xj:()=>a,aX:()=>u,m:()=>n,ql:()=>c,sm:()=>o});var s=t(78070);function a(e,r,t){return s.Z.json({success:!0,data:e,message:r,pagination:t})}function i(e,r=400){return s.Z.json({success:!1,error:e},{status:r})}function n(){return s.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function u(e="資源"){return s.Z.json({success:!1,error:`${e}不存在`},{status:404})}function o(e){return s.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,r,t,s){return{success:r,data:r?e:void 0,error:r?void 0:t,message:r?t:void 0}}},82002:(e,r,t)=>{t.d(r,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>m});var s=t(6521),a=t.n(s),i=t(46082),n=t.n(i),u=t(32455),o=t(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return a().hash(e,12)}async function d(e,r){return a().compare(e,r)}function p(e){let r={userId:e.id,email:e.email,role:e.role};return n().sign(r,c,{expiresIn:"7d"})}async function m(){try{let e=(0,u.cookies)(),r=e.get("auth-token")?.value;if(!r)return null;let t=function(e){try{return n().verify(e,c)}catch(e){return null}}(r);if(!t)return null;return await o._.user.findUnique({where:{id:t.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,r,t)=>{t.d(r,{_:()=>a});var s=t(53524);let a=globalThis.prisma??new s.PrismaClient({log:["query"]})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1216],()=>t(15107));module.exports=s})();