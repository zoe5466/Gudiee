"use strict";(()=>{var e={};e.id=4003,e.ids=[4003],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},91302:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>g});var n={};r.r(n),r.d(n,{GET:()=>l,POST:()=>d});var a=r(95419),i=r(69108),s=r(99678),o=r(34490),c=r(82002),u=r(59413);async function l(e){try{let t=await (0,c.ts)();if(!t)return(0,u.m)();let{searchParams:r}=new URL(e.url),n=parseInt(r.get("page")||"1"),a=parseInt(r.get("limit")||"20"),i=r.get("type"),s=(n-1)*a,l={participants:{has:t.id}};i&&(l.type=i);let[d,p]=await Promise.all([o._.conversation.findMany({where:l,include:{messages:{orderBy:{createdAt:"desc"},take:1,include:{sender:{select:{id:!0,name:!0,avatar:!0}}}}},orderBy:{lastActivityAt:"desc"},skip:s,take:a}),o._.conversation.count({where:l})]),m=await Promise.all(d.map(async e=>{let r=await o._.message.count({where:{conversationId:e.id,senderId:{not:t.id},isRead:!1}}),n=e.participants.filter(e=>e!==t.id),a=await o._.user.findMany({where:{id:{in:n}},select:{id:!0,name:!0,avatar:!0,role:!0}}),i=e.title;return i||"DIRECT"!==e.type||(i=a.map(e=>e.name).join(", ")),{...e,title:i,participants:a,unreadCount:r,lastMessage:e.messages[0]||null}}));return(0,u.Xj)({conversations:m,pagination:{page:n,limit:a,total:p,pages:Math.ceil(p/a)}})}catch(e){return(0,u.VR)("獲取對話列表失敗",500)}}async function d(e){try{let t=await (0,c.ts)();if(!t)return(0,u.m)();let{participantIds:r,title:n,type:a="DIRECT",message:i}=await e.json(),s={};if(r&&Array.isArray(r)&&0!==r.length||(s.participantIds="請選擇對話參與者"),"GROUP"!==a||n||(s.title="群組對話需要標題"),Object.keys(s).length>0)return(0,u.sm)(s);if((await o._.user.findMany({where:{id:{in:r}}})).length!==r.length)return(0,u.VR)("部分參與者不存在",400);if("DIRECT"===a&&1===r.length){let e=await o._.conversation.findFirst({where:{type:"DIRECT",participants:{hasEvery:[t.id,r[0]]}}});if(e)return(0,u.Xj)({conversation:e,isExisting:!0},"對話已存在")}let l=[t.id,...r],d=await o._.conversation.create({data:{type:a,participants:l,title:n||null,lastActivityAt:new Date},include:{messages:{orderBy:{createdAt:"desc"},take:1,include:{sender:{select:{id:!0,name:!0,avatar:!0}}}}}}),p=null;for(let e of(i&&i.trim()&&(p=await o._.message.create({data:{conversationId:d.id,senderId:t.id,content:i.trim(),messageType:"TEXT"},include:{sender:{select:{id:!0,name:!0,avatar:!0}}}}),await o._.conversation.update({where:{id:d.id},data:{lastActivityAt:new Date}})),r))await o._.notification.create({data:{userId:e,type:"MESSAGE_RECEIVED",title:"新對話",content:`${t.name} 開始了新對話`,data:{conversationId:d.id,senderId:t.id},actionUrl:`/messages/${d.id}`}});return(0,u.Xj)({conversation:d,firstMessage:p,isExisting:!1},"對話創建成功")}catch(e){return(0,u.VR)("創建對話失敗",500)}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/conversations/route",pathname:"/api/conversations",filename:"route",bundlePath:"app/api/conversations/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/conversations/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:f,headerHooks:y,staticGenerationBailout:g}=p,h="/api/conversations/route";function w(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:v})}},59413:(e,t,r)=>{r.d(t,{VR:()=>i,Xj:()=>a,aX:()=>o,m:()=>s,ql:()=>u,sm:()=>c});var n=r(78070);function a(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function i(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function s(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function c(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function u(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>m});var n=r(6521),a=r.n(n),i=r(46082),s=r.n(i),o=r(32455),c=r(34490);let u=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return a().hash(e,12)}async function d(e,t){return a().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return s().sign(t,u,{expiresIn:"7d"})}async function m(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return s().verify(e,u)}catch(e){return null}}(t);if(!r)return null;return await c._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>a});var n=r(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(91302));module.exports=n})();