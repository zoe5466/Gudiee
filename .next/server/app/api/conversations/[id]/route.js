"use strict";(()=>{var e={};e.id=1297,e.ids=[1297],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},98283:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>g,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{DELETE:()=>p,GET:()=>d,PUT:()=>l});var a=r(95419),i=r(69108),s=r(99678),u=r(34490),o=r(82002),c=r(59413);async function d(e,{params:t}){try{let e=await (0,o.ts)();if(!e)return(0,c.m)();let r=t.id,n=await u._.conversation.findUnique({where:{id:r},include:{messages:{include:{sender:{select:{id:!0,name:!0,avatar:!0,role:!0}},readStatuses:{include:{user:{select:{id:!0,name:!0,avatar:!0}}}}},orderBy:{createdAt:"asc"}}}});if(!n)return(0,c.VR)("找不到對話",404);if(!n.participants.includes(e.id))return(0,c.VR)("無權限訪問此對話",403);let a=n.participants.filter(t=>t!==e.id),i=await u._.user.findMany({where:{id:{in:a}},select:{id:!0,name:!0,avatar:!0,role:!0}});await u._.message.updateMany({where:{conversationId:r,senderId:{not:e.id},isRead:!1},data:{isRead:!0}});let s=await u._.message.findMany({where:{conversationId:r,senderId:{not:e.id},readStatuses:{none:{userId:e.id}}}});return s.length>0&&await u._.messageReadStatus.createMany({data:s.map(t=>({messageId:t.id,userId:e.id})),skipDuplicates:!0}),(0,c.Xj)({...n,participants:i})}catch(e){return(0,c.VR)("獲取對話失敗",500)}}async function l(e,{params:t}){try{let r=await (0,o.ts)();if(!r)return(0,c.m)();let n=t.id,{title:a}=await e.json(),i=await u._.conversation.findUnique({where:{id:n}});if(!i)return(0,c.VR)("找不到對話",404);if(!i.participants.includes(r.id))return(0,c.VR)("無權限修改此對話",403);let s=await u._.conversation.update({where:{id:n},data:{...a&&{title:a},lastActivityAt:new Date}});return(0,c.Xj)(s,"對話更新成功")}catch(e){return(0,c.VR)("更新對話失敗",500)}}async function p(e,{params:t}){try{let e=await (0,o.ts)();if(!e)return(0,c.m)();let r=t.id,n=await u._.conversation.findUnique({where:{id:r}});if(!n)return(0,c.VR)("找不到對話",404);if(!n.participants.includes(e.id)&&"admin"!==e.role)return(0,c.VR)("無權限刪除此對話",403);return await u._.conversation.delete({where:{id:r}}),(0,c.Xj)(null,"對話刪除成功")}catch(e){return(0,c.VR)("刪除對話失敗",500)}}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/conversations/[id]/route",pathname:"/api/conversations/[id]",filename:"route",bundlePath:"app/api/conversations/[id]/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/conversations/[id]/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:h,headerHooks:w,staticGenerationBailout:y}=f,g="/api/conversations/[id]/route";function x(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},59413:(e,t,r)=>{r.d(t,{VR:()=>i,Xj:()=>a,aX:()=>u,m:()=>s,ql:()=>c,sm:()=>o});var n=r(78070);function a(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function i(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function s(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function u(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function o(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>l,RA:()=>p,c_:()=>d,ts:()=>f});var n=r(6521),a=r.n(n),i=r(46082),s=r.n(i),u=r(32455),o=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function d(e){return a().hash(e,12)}async function l(e,t){return a().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return s().sign(t,c,{expiresIn:"7d"})}async function f(){try{let e=(0,u.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return s().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await o._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>a});var n=r(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(98283));module.exports=n})();