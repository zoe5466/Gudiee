"use strict";(()=>{var e={};e.id=3001,e.ids=[3001],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},59533:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>h});var n={};r.r(n),r.d(n,{GET:()=>d,POST:()=>l});var s=r(95419),a=r(69108),i=r(99678),o=r(34490),u=r(82002),c=r(59413);async function d(e,{params:t}){try{let r=await (0,u.ts)();if(!r)return(0,c.m)();let n=t.id,{searchParams:s}=new URL(e.url),a=parseInt(s.get("page")||"1"),i=parseInt(s.get("limit")||"50"),d=s.get("before"),l=(a-1)*i,p=await o._.conversation.findUnique({where:{id:n}});if(!p)return(0,c.VR)("找不到對話",404);if(!p.participants.includes(r.id))return(0,c.VR)("無權限訪問此對話",403);let m={conversationId:n,isDeleted:!1};d&&(m.createdAt={lt:new Date(d)});let[f,g]=await Promise.all([o._.message.findMany({where:m,include:{sender:{select:{id:!0,name:!0,avatar:!0,role:!0}},readStatuses:{include:{user:{select:{id:!0,name:!0,avatar:!0}}}},replyTo:{include:{sender:{select:{id:!0,name:!0,avatar:!0}}}}},orderBy:{createdAt:"desc"},skip:l,take:i}),o._.message.count({where:m})]),v=f.reverse();return(0,c.Xj)({messages:v,pagination:{page:a,limit:i,total:g,pages:Math.ceil(g/i),hasMore:g>a*i}})}catch(e){return(0,c.VR)("獲取消息失敗",500)}}async function l(e,{params:t}){try{let r=await (0,u.ts)();if(!r)return(0,c.m)();let n=t.id,{content:s,messageType:a="TEXT",attachments:i=[],replyToId:d,metadata:l={}}=await e.json(),p={};if("TEXT"!==a||s&&0!==s.trim().length||(p.content="消息內容不能為空"),"TEXT"===a&&s&&s.trim().length>2e3&&(p.content="消息內容不能超過 2000 字元"),Object.keys(p).length>0)return(0,c.sm)(p);let m=await o._.conversation.findUnique({where:{id:n}});if(!m)return(0,c.VR)("找不到對話",404);if(!m.participants.includes(r.id))return(0,c.VR)("無權限在此對話中發送消息",403);if(d){let e=await o._.message.findUnique({where:{id:d}});if(!e||e.conversationId!==n)return(0,c.VR)("回復的原消息不存在",400)}let f=await o._.message.create({data:{conversationId:n,senderId:r.id,content:s?.trim()||null,messageType:a,attachments:i,replyToId:d||null,metadata:l},include:{sender:{select:{id:!0,name:!0,avatar:!0,role:!0}},replyTo:{include:{sender:{select:{id:!0,name:!0,avatar:!0}}}}}});for(let e of(await o._.conversation.update({where:{id:n},data:{lastActivityAt:new Date,lastMessageId:f.id}}),m.participants.filter(e=>e!==r.id)))await o._.notification.create({data:{userId:e,type:"MESSAGE_RECEIVED",title:"新消息",content:`${r.name}: ${"TEXT"===a?s.substring(0,100):"[附件]"}`,data:{conversationId:n,messageId:f.id,senderId:r.id},actionUrl:`/messages/${n}`}});return(0,c.Xj)(f,"消息發送成功")}catch(e){return(0,c.VR)("發送消息失敗",500)}}let p=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/conversations/[id]/messages/route",pathname:"/api/conversations/[id]/messages",filename:"route",bundlePath:"app/api/conversations/[id]/messages/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/conversations/[id]/messages/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:v,staticGenerationBailout:h}=p,y="/api/conversations/[id]/messages/route";function w(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},59413:(e,t,r)=>{r.d(t,{VR:()=>a,Xj:()=>s,aX:()=>o,m:()=>i,ql:()=>c,sm:()=>u});var n=r(78070);function s(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function a(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function i(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>l,RA:()=>p,c_:()=>d,ts:()=>m});var n=r(6521),s=r.n(n),a=r(46082),i=r.n(a),o=r(32455),u=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function d(e){return s().hash(e,12)}async function l(e,t){return s().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return i().sign(t,c,{expiresIn:"7d"})}async function m(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return i().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await u._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(53524);let s=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(59533));module.exports=n})();