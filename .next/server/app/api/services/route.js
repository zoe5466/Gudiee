"use strict";(()=>{var e={};e.id=84,e.ids=[84],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},64349:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{GET:()=>l,POST:()=>d});var s=r(95419),i=r(69108),a=r(99678),o=r(34490),u=r(82002),c=r(59413);async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("category"),n=t.get("location"),s=t.get("priceMin"),i=t.get("priceMax"),a=t.get("rating"),u=parseInt(t.get("page")||"1"),l=parseInt(t.get("limit")||"12"),d=(u-1)*l,p={};r&&(p.category=r),n&&(p.location={contains:n,mode:"insensitive"}),(s||i)&&(p.price={},s&&(p.price.gte=parseFloat(s)),i&&(p.price.lte=parseFloat(i))),a&&(p.rating={gte:parseFloat(a)});let[g,f]=await Promise.all([o._.service.findMany({where:p,include:{guide:{include:{userProfile:!0}},_count:{select:{reviews:!0,bookings:!0}}},orderBy:{createdAt:"desc"},skip:d,take:l}),o._.service.count({where:p})]),m=Math.ceil(f/l);return(0,c.Xj)(g,"服務列表獲取成功",{page:u,limit:l,total:f,totalPages:m})}catch(e){return(0,c.VR)("獲取服務列表失敗",500)}}async function d(e){try{let t=await (0,u.ts)();if(!t)return(0,c.m)();if("GUIDE"!==t.role)return(0,c.VR)("只有導遊可以創建服務",403);let{title:r,description:n,shortDescription:s,categoryId:i,location:a,coordinates:l,durationHours:d,price:p,currency:g="TWD",maxGuests:f,included:m,notIncluded:v,cancellationPolicy:y,images:x}=await e.json(),h={};if(r||(h.title="服務標題為必填項目"),n||(h.description="服務描述為必填項目"),a||(h.location="服務地點為必填項目"),d||(h.durationHours="服務時長為必填項目"),(!p||p<=0)&&(h.price="請提供有效的價格"),(!f||f<=0)&&(h.maxGuests="請提供有效的最大參與人數"),Object.keys(h).length>0)return(0,c.sm)(h);let j=await o._.service.create({data:{title:r,description:n,shortDescription:s,categoryId:i,location:a,coordinates:l,durationHours:d,price:p,currency:g,maxGuests:f,included:m||[],notIncluded:v||[],cancellationPolicy:y||"",images:x||[],guideId:t.id,status:"DRAFT"},include:{guide:{include:{userProfile:!0}}}});return(0,c.Xj)(j,"服務創建成功")}catch(e){return(0,c.VR)("創建服務失敗",500)}}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/services/route",pathname:"/api/services",filename:"route",bundlePath:"app/api/services/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/services/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:m,headerHooks:v,staticGenerationBailout:y}=p,x="/api/services/route";function h(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},59413:(e,t,r)=>{r.d(t,{VR:()=>i,Xj:()=>s,aX:()=>o,m:()=>a,ql:()=>c,sm:()=>u});var n=r(78070);function s(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function i(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function a(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>g});var n=r(6521),s=r.n(n),i=r(46082),a=r.n(i),o=r(32455),u=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return s().hash(e,12)}async function d(e,t){return s().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return a().sign(t,c,{expiresIn:"7d"})}async function g(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return a().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await u._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(53524);let s=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(64349));module.exports=n})();