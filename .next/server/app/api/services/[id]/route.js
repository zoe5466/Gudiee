"use strict";(()=>{var e={};e.id=692,e.ids=[692],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},46708:(e,t,i)=>{i.r(t),i.d(t,{headerHooks:()=>h,originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>v,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>w});var r={};i.r(r),i.d(r,{DELETE:()=>g,GET:()=>d,PUT:()=>l});var n=i(95419),s=i(69108),o=i(99678),a=i(34490),u=i(82002),c=i(59413);async function d(e,{params:t}){try{let e=await a._.service.findUnique({where:{id:t.id},include:{guide:{include:{userProfile:!0}},category:!0,reviews:{include:{reviewer:{select:{id:!0,name:!0,avatar:!0}}},orderBy:{createdAt:"desc"},take:20},bookings:{where:{status:{in:["CONFIRMED","COMPLETED"]}},select:{id:!0,bookingDate:!0,status:!0},orderBy:{bookingDate:"desc"},take:10},_count:{select:{reviews:!0,bookings:!0}}}});if(!e)return(0,c.aX)("服務");let i=e.reviews.map(e=>e.rating),r=i.length>0?i.reduce((e,t)=>e+t,0)/i.length:0,n=[1,2,3,4,5].reduce((e,t)=>(e[t]=i.filter(e=>e===t).length,e),{}),s=e.bookings.map(e=>e.bookingDate.toISOString().split("T")[0]),o=[],u=new Date;for(let e=1;e<=30;e++){let t=new Date(u);t.setDate(u.getDate()+e);let i=t.toISOString().split("T")[0];s.includes(i)||o.push(i)}let d={id:e.id,title:e.title,description:e.description,shortDescription:e.shortDescription,price:Number(e.price),location:e.location,duration:e.durationHours,maxGuests:e.maxGuests,minGuests:e.minGuests,images:e.images,highlights:e.highlights||[],included:e.included||[],excluded:e.notIncluded||[],cancellationPolicy:e.cancellationPolicy,category:e.category,createdAt:e.createdAt,updatedAt:e.updatedAt,stats:{averageRating:Number(r.toFixed(1)),totalReviews:e._count.reviews,totalBookings:e._count.bookings,ratingDistribution:n},availability:{availableDates:o,bookedDates:s},guide:{id:e.guide.id,name:e.guide.name,avatar:e.guide.avatar,bio:e.guide.userProfile?.bio,location:e.guide.userProfile?.location,languages:e.guide.userProfile?.languages||[],specialties:e.guide.userProfile?.specialties||[],experienceYears:e.guide.userProfile?.experienceYears},reviews:e.reviews.map(e=>({id:e.id,rating:e.rating,comment:e.comment,createdAt:e.createdAt,isAnonymous:e.isAnonymous,reviewer:e.isAnonymous?null:e.reviewer}))};return(0,c.Xj)(d,"服務詳情獲取成功")}catch(e){return(0,c.VR)("獲取服務詳情失敗",500)}}async function l(e,{params:t}){try{let i=await (0,u.ts)();if(!i)return(0,c.m)();let r=await a._.service.findUnique({where:{id:t.id},include:{guide:!0}});if(!r)return(0,c.aX)("服務");if(r.guideId!==i.id&&"ADMIN"!==i.role)return(0,c.VR)("權限不足",403);let{title:n,description:s,category:o,location:d,duration:l,price:g,maxParticipants:p,inclusions:v,exclusions:f,requirements:m,cancellationPolicy:h,highlights:w,itinerary:y,images:x,isActive:P}=await e.json(),b=await a._.service.update({where:{id:t.id},data:{...void 0!==n&&{title:n},...void 0!==s&&{description:s},...void 0!==o&&{category:o},...void 0!==d&&{location:d},...void 0!==l&&{duration:l},...void 0!==g&&{price:g},...void 0!==p&&{maxParticipants:p},...void 0!==v&&{inclusions:v},...void 0!==f&&{exclusions:f},...void 0!==m&&{requirements:m},...void 0!==h&&{cancellationPolicy:h},...void 0!==w&&{highlights:w},...void 0!==y&&{itinerary:y},...void 0!==x&&{images:x},...void 0!==P&&{isActive:P},updatedAt:new Date},include:{guide:{include:{userProfile:!0}}}});return(0,c.Xj)(b,"服務更新成功")}catch(e){return(0,c.VR)("更新服務失敗",500)}}async function g(e,{params:t}){try{let e=await (0,u.ts)();if(!e)return(0,c.m)();let i=await a._.service.findUnique({where:{id:t.id},include:{_count:{select:{bookings:{where:{status:{in:["CONFIRMED","PENDING"]}}}}}}});if(!i)return(0,c.aX)("服務");if(i.guideId!==e.id&&"ADMIN"!==e.role)return(0,c.VR)("權限不足",403);if(i._count.bookings>0)return(0,c.VR)("無法刪除有未完成預訂的服務",400);return await a._.service.delete({where:{id:t.id}}),(0,c.Xj)(null,"服務刪除成功")}catch(e){return(0,c.VR)("刪除服務失敗",500)}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/services/[id]/route",pathname:"/api/services/[id]",filename:"route",bundlePath:"app/api/services/[id]/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/services/[id]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:f,serverHooks:m,headerHooks:h,staticGenerationBailout:w}=p,y="/api/services/[id]/route";function x(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},59413:(e,t,i)=>{i.d(t,{VR:()=>s,Xj:()=>n,aX:()=>a,m:()=>o,ql:()=>c,sm:()=>u});var r=i(78070);function n(e,t,i){return r.Z.json({success:!0,data:e,message:t,pagination:i})}function s(e,t=400){return r.Z.json({success:!1,error:e},{status:t})}function o(){return r.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function a(e="資源"){return r.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return r.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,i,r){return{success:t,data:t?e:void 0,error:t?void 0:i,message:t?i:void 0}}},82002:(e,t,i)=>{i.d(t,{Gv:()=>l,RA:()=>g,c_:()=>d,ts:()=>p});var r=i(6521),n=i.n(r),s=i(46082),o=i.n(s),a=i(32455),u=i(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function d(e){return n().hash(e,12)}async function l(e,t){return n().compare(e,t)}function g(e){let t={userId:e.id,email:e.email,role:e.role};return o().sign(t,c,{expiresIn:"7d"})}async function p(){try{let e=(0,a.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let i=function(e){try{return o().verify(e,c)}catch(e){return null}}(t);if(!i)return null;return await u._.user.findUnique({where:{id:i.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,i)=>{i.d(t,{_:()=>n});var r=i(53524);let n=globalThis.prisma??new r.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[1216],()=>i(46708));module.exports=r})();