"use strict";(()=>{var e={};e.id=1328,e.ids=[1328],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29477:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>l,routeModule:()=>g,serverHooks:()=>d,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>m});var a={};r.r(a),r.d(a,{GET:()=>u});var s=r(95419),i=r(69108),n=r(99678),o=r(34490),c=r(59413);async function u(e){try{let{searchParams:t}=new URL(e.url),r=t.get("q")||"",a=t.get("location")||"",s=t.get("category")||"",i=t.get("minPrice"),n=t.get("maxPrice"),u=t.get("rating"),g=t.get("duration"),l=t.get("maxGuests"),p=t.get("dateFrom"),d=t.get("dateTo");t.get("tags")?.split(",");let v=t.get("sortBy")||"relevance",m=t.get("sortOrder")||"desc",h=parseInt(t.get("page")||"1"),w=parseInt(t.get("limit")||"20"),y=(h-1)*w,f={status:"ACTIVE"};if(r&&(f.OR=[{title:{contains:r,mode:"insensitive"}},{description:{contains:r,mode:"insensitive"}},{shortDescription:{contains:r,mode:"insensitive"}}]),a&&(f.location={contains:a,mode:"insensitive"}),s&&(f.category={slug:s}),(i||n)&&(f.price={},i&&(f.price.gte=parseFloat(i)),n&&(f.price.lte=parseFloat(n))),g){let e=parseInt(g);f.durationHours=e}l&&(f.maxGuests={gte:parseInt(l)}),p&&d&&(f.availability={some:{date:{gte:new Date(p),lte:new Date(d)},isAvailable:!0}});let x={};switch(v){case"price_low":x={price:"asc"};break;case"price_high":x={price:"desc"};break;case"rating":case"newest":default:x={createdAt:"desc"};break;case"duration":x={durationHours:m}}let[_,b]=await Promise.all([o._.service.findMany({where:f,include:{guide:{select:{id:!0,name:!0,avatar:!0,userProfile:{select:{languages:!0,experienceYears:!0}}}},category:{select:{id:!0,name:!0,slug:!0}},reviews:{select:{rating:!0}},_count:{select:{reviews:!0,bookings:!0}}},orderBy:x,skip:y,take:w}),o._.service.count({where:f})]),P=_.map(e=>{let t=e.reviews.map(e=>e.rating),r=t.length>0?t.reduce((e,t)=>e+t,0)/t.length:0,{reviews:a,_count:s,...i}=e;return{...i,averageRating:Number(r.toFixed(1)),totalReviews:s.reviews,totalBookings:s.bookings,popularity:s.bookings>0?Math.min(s.bookings/10,5):0}});"rating"===v&&P.sort((e,t)=>"desc"===m?t.averageRating-e.averageRating:e.averageRating-t.averageRating);let R=await Promise.all([o._.service.aggregate({where:{status:"ACTIVE"},_min:{price:!0},_max:{price:!0}}),o._.service.groupBy({by:["categoryId"],where:{status:"ACTIVE"},_count:{categoryId:!0}}),o._.service.groupBy({by:["location"],where:{status:"ACTIVE"},_count:{location:!0}})]);return(0,c.Xj)({services:P,pagination:{page:h,limit:w,total:b,pages:Math.ceil(b/w),hasNext:h<Math.ceil(b/w),hasPrev:h>1},filters:{priceRange:{min:R[0]._min.price||0,max:R[0]._max.price||1e4},categories:R[1],locations:R[2]},searchParams:{query:r,location:a,category:s,minPrice:i,maxPrice:n,rating:u,duration:g,maxGuests:l,dateFrom:p,dateTo:d,sortBy:v,sortOrder:m}})}catch(e){return(0,c.VR)("搜尋服務失敗",500)}}let g=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/services/search/route",pathname:"/api/services/search",filename:"route",bundlePath:"app/api/services/search/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/services/search/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:d,headerHooks:v,staticGenerationBailout:m}=g,h="/api/services/search/route";function w(){return(0,n.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:p})}},59413:(e,t,r)=>{r.d(t,{VR:()=>i,Xj:()=>s,aX:()=>o,m:()=>n,ql:()=>u,sm:()=>c});var a=r(78070);function s(e,t,r){return a.Z.json({success:!0,data:e,message:t,pagination:r})}function i(e,t=400){return a.Z.json({success:!1,error:e},{status:t})}function n(){return a.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return a.Z.json({success:!1,error:`${e}不存在`},{status:404})}function c(e){return a.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function u(e,t,r,a){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},34490:(e,t,r)=>{r.d(t,{_:()=>s});var a=r(53524);let s=globalThis.prisma??new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1216],()=>r(29477));module.exports=a})();