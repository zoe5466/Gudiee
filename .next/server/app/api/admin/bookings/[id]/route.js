"use strict";(()=>{var e={};e.id=2822,e.ids=[2822],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},65445:(e,t,n)=>{n.r(t),n.d(t,{headerHooks:()=>h,originalPathname:()=>k,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>y});var r={};n.r(r),n.d(r,{GET:()=>d,PATCH:()=>p});var a=n(95419),s=n(69108),i=n(99678),o=n(78070),u=n(82002),c=n(34490),l=n(59413);async function d(e,{params:t}){try{let e=await (0,u.ts)();if(!e||"ADMIN"!==e.role&&"admin"!==e.role)return o.Z.json((0,l.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let n=t.id,r=await c._.booking.findUnique({where:{id:n},include:{service:{include:{guide:{select:{id:!0,name:!0,email:!0,userProfile:!0}}}},traveler:{select:{id:!0,name:!0,email:!0,userProfile:!0}},guide:{select:{id:!0,name:!0,email:!0,userProfile:!0}},payment:!0,reviews:{include:{reviewer:{select:{name:!0,userProfile:{select:{name:!0}}}}}}}});if(!r)return o.Z.json((0,l.ql)(null,!1,"找不到該訂單","NOT_FOUND"),{status:404});return o.Z.json(r)}catch(e){return o.Z.json((0,l.ql)(null,!1,"獲取訂單詳情失敗","INTERNAL_ERROR"),{status:500})}}async function p(e,{params:t}){try{let n=await (0,u.ts)();if(!n||"ADMIN"!==n.role&&"admin"!==n.role)return o.Z.json((0,l.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let r=t.id,{action:a,data:s}=await e.json();switch(a){case"confirm":await c._.booking.update({where:{id:r},data:{status:"CONFIRMED",confirmedAt:new Date}});break;case"cancel":await c._.booking.update({where:{id:r},data:{status:"CANCELLED",cancelledAt:new Date,cancelReason:s?.reason||"Admin cancelled"}});break;case"complete":await c._.booking.update({where:{id:r},data:{status:"COMPLETED",completedAt:new Date}});break;case"refund":await c._.$transaction([c._.booking.update({where:{id:r},data:{status:"CANCELLED",cancelledAt:new Date,cancelReason:"Refunded by admin"}}),c._.payment.updateMany({where:{bookingId:r},data:{status:"REFUNDED",refundedAt:new Date}})]);break;case"update_payment_status":s?.paymentStatus&&await c._.payment.updateMany({where:{bookingId:r},data:{status:s.paymentStatus}});break;case"add_note":s?.note&&await c._.booking.update({where:{id:r},data:{notes:s.note}});break;default:return o.Z.json((0,l.ql)(null,!1,"無效的操作","INVALID_REQUEST"),{status:400})}return o.Z.json((0,l.ql)({success:!0},!0,"操作成功"))}catch(e){return o.Z.json((0,l.ql)(null,!1,"操作失敗","INTERNAL_ERROR"),{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/bookings/[id]/route",pathname:"/api/admin/bookings/[id]",filename:"route",bundlePath:"app/api/admin/bookings/[id]/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/admin/bookings/[id]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:w,headerHooks:h,staticGenerationBailout:y}=m,k="/api/admin/bookings/[id]/route";function b(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},59413:(e,t,n)=>{n.d(t,{VR:()=>s,Xj:()=>a,aX:()=>o,m:()=>i,ql:()=>c,sm:()=>u});var r=n(78070);function a(e,t,n){return r.Z.json({success:!0,data:e,message:t,pagination:n})}function s(e,t=400){return r.Z.json({success:!1,error:e},{status:t})}function i(){return r.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return r.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return r.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,n,r){return{success:t,data:t?e:void 0,error:t?void 0:n,message:t?n:void 0}}},82002:(e,t,n)=>{n.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>m});var r=n(6521),a=n.n(r),s=n(46082),i=n.n(s),o=n(32455),u=n(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return a().hash(e,12)}async function d(e,t){return a().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return i().sign(t,c,{expiresIn:"7d"})}async function m(){try{let e=(0,o.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let n=function(e){try{return i().verify(e,c)}catch(e){return null}}(t);if(!n)return null;return await u._.user.findUnique({where:{id:n.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,n)=>{n.d(t,{_:()=>a});var r=n(53524);let a=globalThis.prisma??new r.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[1216],()=>n(65445));module.exports=r})();