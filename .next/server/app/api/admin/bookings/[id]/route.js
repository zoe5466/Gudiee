"use strict";(()=>{var e={};e.id=2822,e.ids=[2822],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},65445:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>k,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{GET:()=>d,PATCH:()=>p});var a=r(95419),s=r(69108),i=r(99678),u=r(78070),o=r(82002),c=r(34490),l=r(59413);async function d(e,{params:t}){try{let e=await (0,o.ts)();if(!e||"GUIDE"!==e.role)return u.Z.json((0,l.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let r=t.id,n=await c._.booking.findUnique({where:{id:r},include:{service:{include:{guide:{select:{id:!0,name:!0,email:!0,userProfile:!0}}}},traveler:{select:{id:!0,name:!0,email:!0,userProfile:!0}},guide:{select:{id:!0,name:!0,email:!0,userProfile:!0}},payments:!0,reviews:{include:{reviewer:{select:{name:!0,userProfile:{select:{bio:!0,location:!0}}}}}}}});if(!n)return u.Z.json((0,l.ql)(null,!1,"找不到該訂單","NOT_FOUND"),{status:404});return u.Z.json(n)}catch(e){return u.Z.json((0,l.ql)(null,!1,"獲取訂單詳情失敗","INTERNAL_ERROR"),{status:500})}}async function p(e,{params:t}){try{let r=await (0,o.ts)();if(!r||"GUIDE"!==r.role)return u.Z.json((0,l.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let n=t.id,{action:a,data:s}=await e.json();switch(a){case"confirm":await c._.booking.update({where:{id:n},data:{status:"CONFIRMED"}});break;case"cancel":await c._.booking.update({where:{id:n},data:{status:"CANCELLED"}});break;case"complete":await c._.booking.update({where:{id:n},data:{status:"COMPLETED",completedAt:new Date}});break;case"refund":await c._.$transaction([c._.booking.update({where:{id:n},data:{status:"CANCELLED"}}),c._.payment.updateMany({where:{bookingId:n},data:{status:"REFUNDED",refundedAt:new Date}})]);break;case"update_payment_status":s?.paymentStatus&&await c._.payment.updateMany({where:{bookingId:n},data:{status:s.paymentStatus}});break;case"add_note":s?.note;break;default:return u.Z.json((0,l.ql)(null,!1,"無效的操作","INVALID_REQUEST"),{status:400})}return u.Z.json((0,l.ql)({success:!0},!0,"操作成功"))}catch(e){return u.Z.json((0,l.ql)(null,!1,"操作失敗","INTERNAL_ERROR"),{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/bookings/[id]/route",pathname:"/api/admin/bookings/[id]",filename:"route",bundlePath:"app/api/admin/bookings/[id]/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/admin/bookings/[id]/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:w,staticGenerationBailout:y}=m,k="/api/admin/bookings/[id]/route";function b(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},59413:(e,t,r)=>{r.d(t,{VR:()=>s,Xj:()=>a,aX:()=>u,m:()=>i,ql:()=>c,sm:()=>o});var n=r(78070);function a(e,t,r){return n.Z.json({success:!0,data:e,message:t,pagination:r})}function s(e,t=400){return n.Z.json({success:!1,error:e},{status:t})}function i(){return n.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function u(e="資源"){return n.Z.json({success:!1,error:`${e}不存在`},{status:404})}function o(e){return n.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,n){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>m});var n=r(6521),a=r.n(n),s=r(46082),i=r.n(s),u=r(32455),o=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return a().hash(e,12)}async function d(e,t){return a().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return i().sign(t,c,{expiresIn:"7d"})}async function m(){try{let e=(0,u.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return i().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await o._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>a});var n=r(53524);let a=globalThis.prisma??new n.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[1216],()=>r(65445));module.exports=n})();