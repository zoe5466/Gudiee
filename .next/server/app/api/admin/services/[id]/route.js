"use strict";(()=>{var e={};e.id=8611,e.ids=[8611],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},63414:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>A,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>v,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{GET:()=>d,PATCH:()=>p});var n=r(95419),a=r(69108),i=r(99678),u=r(78070),o=r(82002),l=r(34490),c=r(59413);async function d(e,{params:t}){try{let e=await (0,o.ts)();if(!e||"GUIDE"!==e.role)return u.Z.json((0,c.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let{id:r}=t,s=await l._.service.findUnique({where:{id:r},include:{guide:{include:{userProfile:!0}},bookings:{include:{traveler:{include:{userProfile:!0}}},orderBy:{createdAt:"desc"},take:10},reviews:{include:{reviewer:{include:{userProfile:!0}}},orderBy:{createdAt:"desc"}}}});if(!s)return u.Z.json((0,c.ql)(null,!1,"服務不存在","NOT_FOUND"),{status:404});let n={totalBookings:s.bookings.length,totalRevenue:s.bookings.filter(e=>"COMPLETED"===e.status).reduce((e,t)=>e+Number(t.totalAmount),0),averageRating:s.reviews.length>0?s.reviews.reduce((e,t)=>e+t.rating,0)/s.reviews.length:0,totalReviews:s.reviews.length},a={...s,stats:n,recentBookings:s.bookings.map(e=>({id:e.id,travelerName:e.traveler.name||e.traveler.email||"未知",bookingDate:e.bookingDate,guests:e.guests,totalAmount:e.totalAmount,status:e.status,createdAt:e.createdAt})),reviews:s.reviews.map(e=>({id:e.id,rating:e.rating,comment:e.comment,reviewerName:e.reviewer.name||e.reviewer.email||"匿名",createdAt:e.createdAt,photos:e.photos}))};return u.Z.json(a)}catch(e){return u.Z.json((0,c.ql)(null,!1,"獲取服務詳情失敗","INTERNAL_ERROR"),{status:500})}}async function p(e,{params:t}){try{let r=await (0,o.ts)();if(!r||"GUIDE"!==r.role)return u.Z.json((0,c.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let{id:s}=t,{action:n,reason:a}=await e.json(),i={},d="";switch(n){case"approve":i={status:"ACTIVE",reviewedAt:new Date,reviewedBy:r.id},d="服務已通過審核";break;case"reject":i={status:"REJECTED",reviewedAt:new Date,reviewedBy:r.id,rejectionReason:a},d="服務已被拒絕";break;case"suspend":i={status:"SUSPENDED",suspendedAt:new Date,suspendedBy:r.id,suspensionReason:a},d="服務已被暫停";break;case"activate":i={status:"ACTIVE",suspendedAt:null,suspendedBy:null,suspensionReason:null},d="服務已重新啟用";break;default:return u.Z.json((0,c.ql)(null,!1,"無效的操作","INVALID_REQUEST"),{status:400})}return await l._.service.update({where:{id:s},data:i}),u.Z.json((0,c.ql)(null,!0,d))}catch(e){return u.Z.json((0,c.ql)(null,!1,"操作失敗","INTERNAL_ERROR"),{status:500})}}let v=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/services/[id]/route",pathname:"/api/admin/services/[id]",filename:"route",bundlePath:"app/api/admin/services/[id]/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/admin/services/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:w,staticGenerationBailout:h}=v,A="/api/admin/services/[id]/route";function y(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},59413:(e,t,r)=>{r.d(t,{VR:()=>a,Xj:()=>n,aX:()=>u,m:()=>i,ql:()=>l,sm:()=>o});var s=r(78070);function n(e,t,r){return s.Z.json({success:!0,data:e,message:t,pagination:r})}function a(e,t=400){return s.Z.json({success:!1,error:e},{status:t})}function i(){return s.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function u(e="資源"){return s.Z.json({success:!1,error:`${e}不存在`},{status:404})}function o(e){return s.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function l(e,t,r,s){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>c,ts:()=>v});var s=r(6521),n=r.n(s),a=r(46082),i=r.n(a),u=r(32455),o=r(34490);let l=process.env.JWT_SECRET||"your-fallback-secret";async function c(e){return n().hash(e,12)}async function d(e,t){return n().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return i().sign(t,l,{expiresIn:"7d"})}async function v(){try{let e=(0,u.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return i().verify(e,l)}catch(e){return null}}(t);if(!r)return null;return await o._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>n});var s=r(53524);let n=globalThis.prisma??new s.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1216],()=>r(63414));module.exports=s})();