"use strict";(()=>{var e={};e.id=3508,e.ids=[3508],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14873:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>E});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>d});var a=r(95419),i=r(69108),u=r(99678),o=r(78070);let n=new(r(53524)).PrismaClient;async function c(e){try{let{searchParams:t}=new URL(e.url),r=t.get("status"),s=t.get("category"),a=t.get("userId"),i={};r&&"ALL"!==r&&("UNREAD"===r?i.status="SENT":"PENDING"===r?i.status="READ":"RESOLVED"===r&&(i.status="REPLIED")),s&&"ALL"!==s&&(i.category=s),a&&(i.userId=a);let u=(await n.supportTicket.findMany({where:i,include:{user:{include:{userProfile:!0}},replies:{include:{admin:{include:{userProfile:!0}}},orderBy:{createdAt:"asc"}}},orderBy:{createdAt:"desc"}})).map(e=>({id:e.id,userId:e.userId,userType:"GUIDE"===e.user.role?"GUIDE":"USER",userName:e.user.userProfile?.name||e.user.email,userAvatar:e.user.userProfile?.avatar||null,message:e.message,timestamp:e.createdAt.toISOString(),status:e.status,priority:e.priority,category:e.category,replies:e.replies.map(e=>({id:e.id,adminId:e.adminId,adminName:e.admin.userProfile?.name||e.admin.email,message:e.message,timestamp:e.createdAt.toISOString()}))})),c=await n.supportTicket.count(),d=await n.supportTicket.count({where:{status:"SENT"}}),p=await n.supportTicket.count({where:{status:"READ"}}),l=await n.supportTicket.count({where:{status:"REPLIED"}}),m=new Date;m.setHours(0,0,0,0);let g=await n.supportTicket.count({where:{createdAt:{gte:m}}});return o.Z.json({success:!0,chats:u,stats:{totalChats:c,unreadChats:d,pendingChats:p,resolvedChats:l,averageResponseTime:"12 分鐘",todayMessages:g}})}catch(e){return o.Z.json({success:!1,error:"Failed to fetch chats"},{status:500})}}async function d(e){try{let{userId:t,message:r,category:s="GENERAL",priority:a="NORMAL"}=await e.json();if(!t||!r)return o.Z.json({success:!1,error:"User ID and message are required"},{status:400});let i=await n.supportTicket.create({data:{userId:t,message:r,category:s,priority:a,status:"SENT"},include:{user:{include:{userProfile:!0}}}}),u={id:i.id,userId:i.userId,userType:"GUIDE"===i.user.role?"GUIDE":"USER",userName:i.user.userProfile?.name||i.user.email,userAvatar:i.user.userProfile?.avatar||null,message:i.message,timestamp:i.createdAt.toISOString(),status:i.status,priority:i.priority,category:i.category,replies:[]};return o.Z.json({success:!0,chat:u})}catch(e){return o.Z.json({success:!1,error:"Failed to create chat"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/chat/route",pathname:"/api/admin/chat",filename:"route",bundlePath:"app/api/admin/chat/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/admin/chat/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:h,staticGenerationBailout:E}=p,y="/api/admin/chat/route";function A(){return(0,u.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1216],()=>r(14873));module.exports=s})();