"use strict";(()=>{var e={};e.id=3508,e.ids=[3508],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14873:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>E});var a={};r.r(a),r.d(a,{GET:()=>c,POST:()=>d});var s=r(95419),i=r(69108),u=r(99678),n=r(78070);let o=new(r(53524)).PrismaClient;async function c(e){try{let{searchParams:t}=new URL(e.url),r=t.get("status"),a=t.get("category"),s=t.get("userId"),i={};r&&"ALL"!==r&&("UNREAD"===r?i.status="SENT":"PENDING"===r?i.status="READ":"RESOLVED"===r&&(i.status="REPLIED")),a&&"ALL"!==a&&(i.category=a),s&&(i.userId=s);let u=(await o.supportTicket.findMany({where:i,include:{user:{include:{userProfile:!0}},replies:{include:{admin:{include:{userProfile:!0}}},orderBy:{createdAt:"asc"}}},orderBy:{createdAt:"desc"}})).map(e=>({id:e.id,userId:e.userId,userType:"GUIDE"===e.user.role?"GUIDE":"USER",userName:e.user.name||e.user.email,userAvatar:null,message:e.message,timestamp:e.createdAt.toISOString(),status:e.status,priority:e.priority,category:e.category,replies:e.replies.map(e=>({id:e.id,adminId:e.adminId,adminName:e.admin.name||e.admin.email,message:e.message,timestamp:e.createdAt.toISOString()}))})),c=await o.supportTicket.count(),d=await o.supportTicket.count({where:{status:"SENT"}}),p=await o.supportTicket.count({where:{status:"READ"}}),m=await o.supportTicket.count({where:{status:"REPLIED"}}),l=new Date;l.setHours(0,0,0,0);let g=await o.supportTicket.count({where:{createdAt:{gte:l}}});return n.Z.json({success:!0,chats:u,stats:{totalChats:c,unreadChats:d,pendingChats:p,resolvedChats:m,averageResponseTime:"12 分鐘",todayMessages:g}})}catch(e){return n.Z.json({success:!1,error:"Failed to fetch chats"},{status:500})}}async function d(e){try{let{userId:t,message:r,category:a="GENERAL",priority:s="NORMAL"}=await e.json();if(!t||!r)return n.Z.json({success:!1,error:"User ID and message are required"},{status:400});let i=await o.supportTicket.create({data:{userId:t,message:r,category:a,priority:s,status:"SENT"},include:{user:{include:{userProfile:!0}}}}),u={id:i.id,userId:i.userId,userType:"GUIDE"===i.user.role?"GUIDE":"USER",userName:i.user.name||i.user.email,userAvatar:null,message:i.message,timestamp:i.createdAt.toISOString(),status:i.status,priority:i.priority,category:i.category,replies:[]};return n.Z.json({success:!0,chat:u})}catch(e){return n.Z.json({success:!1,error:"Failed to create chat"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/chat/route",pathname:"/api/admin/chat",filename:"route",bundlePath:"app/api/admin/chat/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/admin/chat/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:l,serverHooks:g,headerHooks:h,staticGenerationBailout:E}=p,y="/api/admin/chat/route";function A(){return(0,u.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:l})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1216],()=>r(14873));module.exports=a})();