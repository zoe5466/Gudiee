"use strict";(()=>{var e={};e.id=1317,e.ids=[1317],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},89595:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>A,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>h});var s={};r.r(s),r.d(s,{GET:()=>d,PATCH:()=>p});var i=r(95419),n=r(69108),a=r(99678),u=r(78070),o=r(82002),c=r(34490),l=r(59413);async function d(e,{params:t}){try{let e=await (0,o.ts)();if(!e||"ADMIN"!==e.role&&"admin"!==e.role)return u.Z.json((0,l.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let{id:r}=t,s=await c._.user.findUnique({where:{id:r},include:{userProfile:!0,services:{include:{_count:{select:{bookings:!0,reviews:!0}}}},bookings:{include:{service:!0,guide:{include:{userProfile:!0}}},orderBy:{createdAt:"desc"},take:10},reviews:{include:{service:!0},orderBy:{createdAt:"desc"},take:10}}});if(!s)return u.Z.json((0,l.ql)(null,!1,"用戶不存在","NOT_FOUND"),{status:404});let i={servicesCount:s.services.length,bookingsCount:s.bookings.length,reviewsCount:s.reviews.length,totalEarnings:"GUIDE"===s.role?s.bookings.filter(e=>"COMPLETED"===e.status).reduce((e,t)=>e+t.totalAmount,0):0,averageRating:s.reviews.length>0?s.reviews.reduce((e,t)=>e+t.rating,0)/s.reviews.length:0},n={id:s.id,email:s.email,name:s.name,role:s.role,isEmailVerified:s.isEmailVerified,isKycVerified:s.isKycVerified,createdAt:s.createdAt,lastLoginAt:s.lastLoginAt,userProfile:s.userProfile,stats:i,recentServices:s.services.slice(0,5).map(e=>({id:e.id,title:e.title,status:e.status,createdAt:e.createdAt,price:e.price})),recentBookings:s.bookings.slice(0,5).map(e=>({id:e.id,serviceTitle:e.service.title,bookingDate:e.bookingDate,status:e.status,totalAmount:e.totalAmount})),recentReviews:s.reviews.slice(0,5).map(e=>({id:e.id,serviceTitle:e.service.title,rating:e.rating,comment:e.comment,createdAt:e.createdAt}))};return u.Z.json(n)}catch(e){return u.Z.json((0,l.ql)(null,!1,"獲取用戶詳情失敗","INTERNAL_ERROR"),{status:500})}}async function p(e,{params:t}){try{let r=await (0,o.ts)();if(!r||"ADMIN"!==r.role&&"admin"!==r.role)return u.Z.json((0,l.ql)(null,!1,"無權限訪問","UNAUTHORIZED"),{status:403});let{id:s}=t,{action:i,data:n}=await e.json();switch(i){case"suspend":await c._.user.update({where:{id:s},data:{isActive:!1,suspendedAt:new Date}});break;case"activate":await c._.user.update({where:{id:s},data:{isActive:!0,suspendedAt:null}});break;case"verify_email":await c._.user.update({where:{id:s},data:{isEmailVerified:!0,emailVerifiedAt:new Date}});break;case"verify_kyc":await c._.user.update({where:{id:s},data:{isKycVerified:!0,kycVerifiedAt:new Date}});break;case"update_role":n.role&&await c._.user.update({where:{id:s},data:{role:n.role}});break;case"update_permissions":n.permissions&&await c._.user.update({where:{id:s},data:{permissions:n.permissions}});break;default:return u.Z.json((0,l.ql)(null,!1,"無效的操作","INVALID_REQUEST"),{status:400})}return u.Z.json((0,l.ql)(null,!0,"操作成功"))}catch(e){return u.Z.json((0,l.ql)(null,!1,"操作失敗","INTERNAL_ERROR"),{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/users/[id]/route",pathname:"/api/admin/users/[id]",filename:"route",bundlePath:"app/api/admin/users/[id]/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/admin/users/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:v,serverHooks:g,headerHooks:w,staticGenerationBailout:h}=m,A="/api/admin/users/[id]/route";function y(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:v})}},59413:(e,t,r)=>{r.d(t,{VR:()=>n,Xj:()=>i,aX:()=>u,m:()=>a,ql:()=>c,sm:()=>o});var s=r(78070);function i(e,t,r){return s.Z.json({success:!0,data:e,message:t,pagination:r})}function n(e,t=400){return s.Z.json({success:!1,error:e},{status:t})}function a(){return s.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function u(e="資源"){return s.Z.json({success:!1,error:`${e}不存在`},{status:404})}function o(e){return s.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,r,s){return{success:t,data:t?e:void 0,error:t?void 0:r,message:t?r:void 0}}},82002:(e,t,r)=>{r.d(t,{Gv:()=>d,RA:()=>p,c_:()=>l,ts:()=>m});var s=r(6521),i=r.n(s),n=r(46082),a=r.n(n),u=r(32455),o=r(34490);let c=process.env.JWT_SECRET||"your-fallback-secret";async function l(e){return i().hash(e,12)}async function d(e,t){return i().compare(e,t)}function p(e){let t={userId:e.id,email:e.email,role:e.role};return a().sign(t,c,{expiresIn:"7d"})}async function m(){try{let e=(0,u.cookies)(),t=e.get("auth-token")?.value;if(!t)return null;let r=function(e){try{return a().verify(e,c)}catch(e){return null}}(t);if(!r)return null;return await o._.user.findUnique({where:{id:r.userId},include:{userProfile:!0}})}catch(e){return null}}},34490:(e,t,r)=>{r.d(t,{_:()=>i});var s=r(53524);let i=globalThis.prisma??new s.PrismaClient({log:["query"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1216],()=>r(89595));module.exports=s})();