"use strict";(()=>{var e={};e.id=2264,e.ids=[2264],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25791:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>p,originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>m});var r={};s.r(r),s.d(r,{GET:()=>c});var i=s(95419),a=s(69108),n=s(99678),o=s(34490),u=s(59413);async function c(e){try{let{searchParams:t}=new URL(e.url),s=t.get("q")||"",r=t.get("location")||"",i=t.get("language")||"",a=t.get("specialty")||"",n=t.get("minRating"),c=t.get("minExperience"),l=t.get("sortBy")||"rating",d=t.get("sortOrder")||"desc",g=parseInt(t.get("page")||"1"),v=parseInt(t.get("limit")||"20"),p=(g-1)*v,m={role:"GUIDE",isEmailVerified:!0,guidedServices:{some:{status:"ACTIVE"}}};s&&(m.OR=[{name:{contains:s,mode:"insensitive"}},{userProfile:{bio:{contains:s,mode:"insensitive"}}}]),r&&(m.userProfile={...m.userProfile,location:{contains:r,mode:"insensitive"}}),i&&(m.userProfile={...m.userProfile,languages:{has:i}}),a&&(m.userProfile={...m.userProfile,specialties:{has:a}}),c&&(m.userProfile={...m.userProfile,experienceYears:{gte:parseInt(c)}});let f={};switch(l){case"name":f={name:d};break;case"experience":f={userProfile:{experienceYears:d}};break;default:f={createdAt:"desc"}}let[h,P]=await Promise.all([o._.user.findMany({where:m,include:{userProfile:!0,guidedServices:{where:{status:"ACTIVE"},select:{id:!0,title:!0,price:!0,location:!0,images:!0,_count:{select:{bookings:!0,reviews:!0}}},take:3,orderBy:{createdAt:"desc"}},reviewsAsGuide:{select:{rating:!0}},_count:{select:{guidedServices:!0,reviewsAsGuide:!0,bookingsAsGuide:!0}}},orderBy:f,skip:p,take:v}),o._.user.count({where:m})]),R=h.map(e=>{let t=e.reviewsAsGuide.map(e=>e.rating),s=t.length>0?t.reduce((e,t)=>e+t,0)/t.length:0,r=e.guidedServices.reduce((e,t)=>e+(t._count?.bookings||0),0),i=e.guidedServices.reduce((e,t)=>e+(t._count?.reviews||0),0),{reviewsAsGuide:a,...n}=e;return{...n,stats:{averageRating:Number(s.toFixed(1)),totalReviews:i,totalBookings:r,activeServices:e._count.guidedServices,responseRate:95+Math.floor(5*Math.random())}}});"rating"===l?R.sort((e,t)=>"desc"===d?t.stats.averageRating-e.stats.averageRating:e.stats.averageRating-t.stats.averageRating):"services"===l&&R.sort((e,t)=>"desc"===d?t.stats.activeServices-e.stats.activeServices:e.stats.activeServices-t.stats.activeServices);let w=R;n&&(w=R.filter(e=>e.stats.averageRating>=parseFloat(n)));let[x,S,k]=await Promise.all([o._.userProfile.groupBy({by:["location"],where:{user:{role:"GUIDE",isEmailVerified:!0},location:{not:null}},_count:{location:!0},orderBy:{_count:{location:"desc"}},take:10}),Promise.resolve([]),Promise.resolve([])]);return(0,u.Xj)({guides:w,pagination:{page:g,limit:v,total:w.length,pages:Math.ceil(w.length/v),hasNext:g<Math.ceil(w.length/v),hasPrev:g>1},filters:{locations:x,languages:S,specialties:k},searchParams:{query:s,location:r,language:i,specialty:a,minRating:n,minExperience:c,sortBy:l,sortOrder:d}})}catch(e){return(0,u.VR)("取得嚮導列表失敗",500)}}let l=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/guides/route",pathname:"/api/guides",filename:"route",bundlePath:"app/api/guides/route"},resolvedPagePath:"/Users/zoechang/projects/Guidee/src/app/api/guides/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:g,serverHooks:v,headerHooks:p,staticGenerationBailout:m}=l,f="/api/guides/route";function h(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}},59413:(e,t,s)=>{s.d(t,{VR:()=>a,Xj:()=>i,aX:()=>o,m:()=>n,ql:()=>c,sm:()=>u});var r=s(78070);function i(e,t,s){return r.Z.json({success:!0,data:e,message:t,pagination:s})}function a(e,t=400){return r.Z.json({success:!1,error:e},{status:t})}function n(){return r.Z.json({success:!1,error:"未經授權的請求"},{status:401})}function o(e="資源"){return r.Z.json({success:!1,error:`${e}不存在`},{status:404})}function u(e){return r.Z.json({success:!1,error:"驗證失敗",data:e},{status:422})}function c(e,t,s,r){return{success:t,data:t?e:void 0,error:t?void 0:s,message:t?s:void 0}}},34490:(e,t,s)=>{s.d(t,{_:()=>i});var r=s(53524);let i=globalThis.prisma??new r.PrismaClient({log:["query"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[1216],()=>s(25791));module.exports=r})();